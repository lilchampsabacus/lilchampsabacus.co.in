<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Li'l Champs Abacus Academy - Formula Master</title>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;700;900&family=Verdana:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #fbf0d9;
            --text-color: #5f4b32;
            --card-bg: #fffbf0;
            --accent: #d76a03;
            --brand-color: #4a3b2a;
            --success: #2e7d32;
            --error: #c62828;
            --btn-border: #e6dcc8;
        }

        /* --- LAYOUT RESET FOR MOBILE --- */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { 
            font-family: 'Merriweather', serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            display: flex; 
            flex-direction: column; 
        }

        /* --- HEADER & FOOTER (Fixed) --- */
        .brand-header { flex: 0 0 auto; background: #eddec5; text-align: center; padding: 10px; border-bottom: 2px solid #e0d0b8; }
        .brand-title { font-family: 'Verdana', sans-serif; font-weight: 900; font-size: 1.2rem; color: var(--brand-color); text-transform: uppercase; margin: 0; }
        .brand-footer { flex: 0 0 auto; background: #eddec5; text-align: center; padding: 10px; border-top: 2px solid #e0d0b8; font-family: 'Verdana', sans-serif; font-size: 0.9rem; }

        /* --- MAIN CONTAINER --- */
        .container { 
            flex: 1 1 auto; 
            display: flex; 
            flex-direction: column; 
            width: 100%; 
            max-width: 600px; 
            margin: 0 auto; 
            overflow: hidden; /* Prevents body scroll */
            position: relative;
        }

        /* --- SETUP SCREEN --- */
        #setup-screen { overflow-y: auto; padding: 20px; text-align: center; height: 100%; }
        .level-btn { 
            width: 100%; display: block; background: white; border: 2px solid var(--btn-border); border-bottom: 4px solid var(--btn-border);
            padding: 15px; margin-bottom: 15px; border-radius: 12px; text-align: left;
            font-family: 'Verdana', sans-serif; font-weight: bold; color: var(--brand-color); cursor: pointer; position: relative;
        }
        .level-btn:active { transform: translateY(2px); border-bottom: 2px solid var(--btn-border); }
        .level-btn span { display: block; font-size: 0.8rem; font-weight: normal; color: #888; margin-top: 2px; }

        /* --- GAME SCREEN (Split Layout) --- */
        #game-screen { display: none; flex-direction: column; height: 100%; padding: 10px; }
        
        /* Top Bar (Fixed) */
        .top-bar { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .progress-pill { background: #e0d0b8; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; font-family: 'Verdana', sans-serif;}
        
        /* Timer (Fixed) */
        .timer-container { flex: 0 0 auto; width: 100%; height: 6px; background: #e0d0b8; border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
        .timer-bar { height: 100%; width: 100%; background: var(--accent); transition: width 1s linear; }

        /* Question Area (FIXED - NOT SCROLLABLE) */
        .formula-card {
            flex: 0 0 auto; /* Do not shrink or grow */
            background: var(--card-bg);
            padding: 30px 10px;
            text-align: center;
            border-radius: 12px;
            border: 2px solid var(--btn-border);
            margin-bottom: 15px;
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .formula-label { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); font-family: 'Verdana', sans-serif; font-size: 0.8rem; font-weight: 900; color: #999; text-transform: uppercase; }
        .formula-text { font-size: 3.5rem; font-weight: 900; color: #333; margin-top: 10px; line-height: 1; }

        /* Options Area (Fill remaining space) */
        .options-grid {
            flex: 1 1 auto; /* Take remaining space */
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: repeat(2, 1fr); /* 2x2 grid */
            gap: 10px;
            overflow-y: auto; /* Scroll ONLY if buttons overflow on tiny screens */
            padding-bottom: 10px;
        }
        
        .option-btn {
            background: white; border: 2px solid var(--btn-border); border-bottom: 4px solid var(--btn-border);
            color: var(--text-color); font-size: 1.5rem; font-weight: bold; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.1s; font-family: 'Verdana', sans-serif;
            min-height: 80px; /* Ensure touch target size */
        }
        .option-btn:active { transform: translateY(2px); border-bottom: 2px solid var(--btn-border); background-color: #f0f0f0; }

        /* --- REPORT & REVIEW AREA --- */
        #report-screen { display: none; flex-direction: column; height: 100%; padding: 20px; overflow-y: auto; text-align: center; }
        .review-card { background: white; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; padding: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header class="brand-header">
        <h1 class="brand-title">Li'l Champs Academy</h1>
    </header>

    <div class="container">
        
        <div id="setup-screen">
            <h2 class="text-xl font-bold mb-2">Select Formula Level</h2>
            <div class="mb-4 text-sm text-gray-500">Student: <span id="student-name" class="font-bold">Loading...</span></div>
            
            <button class="level-btn" onclick="startGame('Small Friend')">
                Level 1: Small Friends
                <span>Formulas for ¬±1 to ¬±4</span>
            </button>
            <button class="level-btn" onclick="startGame('Big Friend')">
                Level 2: Big Friends
                <span>Formulas for ¬±1 to ¬±9</span>
            </button>
            <button class="level-btn" onclick="startGame('Combination')">
                Level 3: Combination
                <span>Complex formulas (¬±6 to ¬±9)</span>
            </button>
            <button class="level-btn" style="border-color: #d76a03; color: #d76a03;" onclick="startGame('mix')">
                üèÜ Master Mode
                <span>Mix of all formulas</span>
            </button>
        </div>

        <div id="game-screen">
            <div class="top-bar">
                <div class="progress-pill">Q: <span id="q-current">1</span> / <span id="q-total">20</span></div>
                <div class="font-bold text-orange-600 text-sm">Score: <span id="score">0</span></div>
            </div>

            <div class="timer-container">
                <div class="timer-bar" id="timer-bar"></div>
            </div>

            <div class="formula-card">
                <span class="formula-label" id="type-label">Big Friend</span>
                <div class="formula-text" id="question">?</div>
            </div>

            <div class="options-grid" id="options">
                </div>
        </div>

        <div id="report-screen">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Mission Complete!</h2>
            <div class="text-4xl font-black text-green-600 mb-4"><span id="final-score">0</span><span class="text-xl text-gray-400">/20</span></div>
            
            <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                <div class="bg-blue-50 p-2 rounded border border-blue-100">
                    <div class="text-gray-500">Accuracy</div>
                    <div class="font-bold text-blue-800" id="final-accuracy">0%</div>
                </div>
                <div class="bg-orange-50 p-2 rounded border border-orange-100">
                    <div class="text-gray-500">Status</div>
                    <div class="font-bold text-orange-800" id="final-status">Completed</div>
                </div>
            </div>

            <button onclick="location.reload()" class="w-full bg-gray-800 text-white font-bold py-3 rounded-lg mb-3 shadow-lg">
                üîÑ Play Again
            </button>
            
            <button id="review-btn" onclick="showMistakes()" class="w-full bg-red-100 text-red-700 font-bold py-3 rounded-lg mb-3 hidden">
                Review Mistakes
            </button>
            
            <div id="mistakes-list" class="hidden text-left w-full mt-4">
                <h3 class="text-lg font-bold text-gray-700 mb-2 border-b pb-1">Correction Log</h3>
                </div>
        </div>

    </div>

    <footer class="brand-footer">
        Contact: 9730482620
    </footer>

    <script>
        // --- AUTH CHECK ---
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = 'index.html';
        }

        // --- DATA ---
        const allFormulas = [
            { q: "+9", a: "-1+10", type: "Big Friend" }, { q: "+8", a: "-2+10", type: "Big Friend" },
            { q: "+7", a: "-3+10", type: "Big Friend" }, { q: "+6", a: "-4+10", type: "Big Friend" },
            { q: "+5", a: "-5+10", type: "Big Friend" }, { q: "+4", a: "-6+10", type: "Big Friend" },
            { q: "+3", a: "-7+10", type: "Big Friend" }, { q: "+2", a: "-8+10", type: "Big Friend" },
            { q: "+1", a: "-9+10", type: "Big Friend" },
            { q: "-9", a: "-10+1", type: "Big Friend" }, { q: "-8", a: "-10+2", type: "Big Friend" },
            { q: "-7", a: "-10+3", type: "Big Friend" }, { q: "-6", a: "-10+4", type: "Big Friend" },
            { q: "-5", a: "-10+5", type: "Big Friend" }, { q: "-4", a: "-10+6", type: "Big Friend" },
            { q: "-3", a: "-10+7", type: "Big Friend" }, { q: "-2", a: "-10+8", type: "Big Friend" },
            { q: "-1", a: "-10+9", type: "Big Friend" },
            { q: "+1", a: "+5-4", type: "Small Friend" }, { q: "+2", a: "+5-3", type: "Small Friend" },
            { q: "+3", a: "+5-2", type: "Small Friend" }, { q: "+4", a: "+5-1", type: "Small Friend" },
            { q: "-1", a: "+4-5", type: "Small Friend" }, { q: "-2", a: "+3-5", type: "Small Friend" },
            { q: "-3", a: "+2-5", type: "Small Friend" }, { q: "-4", a: "+1-5", type: "Small Friend" },
            { q: "+6", a: "+1-5+10", type: "Combination" }, { q: "+7", a: "+2-5+10", type: "Combination" },
            { q: "+8", a: "+3-5+10", type: "Combination" }, { q: "+9", a: "+4-5+10", type: "Combination" },
            { q: "-6", a: "-10+5-1", type: "Combination" }, { q: "-7", a: "-10+5-2", type: "Combination" },
            { q: "-8", a: "-10+5-3", type: "Combination" }, { q: "-9", a: "-10+5-4", type: "Combination" }
        ];

        // --- STATE ---
        const TIME_LIMIT = 20; // Seconds per question
        const TOTAL_QUESTIONS = 20;
        let gamePool = [];
        let userHistory = []; // Stores {q, correct, selected, isCorrect}
        let score = 0;
        let questionIndex = 0;
        let currentItem = null;
        let timerInterval = null;
        let timeLeft = TIME_LIMIT;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            const studentId = sessionStorage.getItem('studentIdentifier');
            const name = studentId ? studentId.split('@')[0].split('.').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') : "Student";
            document.getElementById('student-name').innerText = name;
        });

        function startGame(level) {
            // Filter
            if (level === 'mix') gamePool = [...allFormulas];
            else gamePool = allFormulas.filter(f => f.type === level);
            
            // Randomize & Slice to 20
            gamePool.sort(() => Math.random() - 0.5);
            // Ensure we have enough questions, repeat if necessary or just take what we have
            // For now, infinite random pull logic used in loop
            
            score = 0;
            questionIndex = 0;
            userHistory = [];
            
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex'; // Flex to support split layout
            
            nextQuestion();
        }

        function nextQuestion() {
            if (questionIndex >= TOTAL_QUESTIONS) {
                endGame();
                return;
            }

            questionIndex++;
            document.getElementById('q-current').innerText = questionIndex;
            document.getElementById('q-total').innerText = TOTAL_QUESTIONS;
            
            // Pick Random from pool or rotate
            currentItem = gamePool[Math.floor(Math.random() * gamePool.length)];
            
            document.getElementById('question').innerText = currentItem.q;
            document.getElementById('type-label').innerText = currentItem.type;

            // Generate Options
            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = '';
            
            let answers = [currentItem.a];
            while(answers.length < 4) {
                let fake = generateFake(currentItem.a);
                if(!answers.includes(fake)) answers.push(fake);
            }
            answers.sort(() => Math.random() - 0.5);

            answers.forEach(ans => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.innerText = ans;
                // No feedback colors, just submit
                btn.onclick = () => handleAnswer(ans); 
                optionsDiv.appendChild(btn);
            });

            // Reset Timer
            resetTimer();
        }

        function handleAnswer(selectedVal) {
            clearInterval(timerInterval);
            
            const isCorrect = (selectedVal === currentItem.a);
            if (isCorrect) score++;
            document.getElementById('score').innerText = score;

            // Save History
            userHistory.push({
                q: currentItem.q,
                type: currentItem.type,
                correct: currentItem.a,
                selected: selectedVal,
                isCorrect: isCorrect
            });

            // IMMEDIATE NEXT (No Delay, No Colors)
            nextQuestion();
        }

        function resetTimer() {
            timeLeft = TIME_LIMIT;
            updateTimerBar();
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerBar();
                if (timeLeft <= 0) {
                    // Timeout = Wrong/Skipped
                    handleAnswer("Timeout");
                }
            }, 1000);
        }

        function updateTimerBar() {
            const bar = document.getElementById('timer-bar');
            const pct = (timeLeft / TIME_LIMIT) * 100;
            bar.style.width = pct + '%';
            if(timeLeft < 5) bar.style.backgroundColor = '#c62828';
            else bar.style.backgroundColor = '#d76a03';
        }

        function generateFake(correct) {
            const methods = [
                s => s.replace('+', 'TEMP').replace('-', '+').replace('TEMP', '-'),
                s => s.includes('10') ? s.replace('10', '5') : s.replace('5', '10'),
                s => {
                    const nums = s.match(/\d+/g);
                    if(nums) {
                        const target = nums[nums.length - 1]; 
                        const newVal = Math.abs(parseInt(target) + (Math.random()>0.5?1:-1));
                        return s.replace(target, newVal);
                    }
                    return s;
                }
            ];
            const randomMethod = methods[Math.floor(Math.random() * methods.length)];
            return randomMethod(correct);
        }

        // --- REPORTING ---
        function endGame() {
            clearInterval(timerInterval);
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('report-screen').style.display = 'flex';

            document.getElementById('final-score').innerText = score;
            const accuracy = Math.round((score / TOTAL_QUESTIONS) * 100);
            document.getElementById('final-accuracy').innerText = accuracy + "%";

            // Check for mistakes
            const mistakes = userHistory.filter(h => !h.isCorrect);
            const reviewBtn = document.getElementById('review-btn');
            
            if (mistakes.length > 0) {
                reviewBtn.classList.remove('hidden');
                reviewBtn.innerText = `Review ${mistakes.length} Mistakes`;
            } else {
                reviewBtn.classList.add('hidden');
            }
        }

        function showMistakes() {
            const list = document.getElementById('mistakes-list');
            list.innerHTML = '<h3 class="text-lg font-bold text-gray-700 mb-2 border-b pb-1">Correction Log</h3>';
            list.classList.remove('hidden');
            
            userHistory.filter(h => !h.isCorrect).forEach(item => {
                const card = document.createElement('div');
                card.className = 'review-card';
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold text-gray-400 uppercase">${item.type}</span>
                        <span class="text-xl font-black text-gray-800">${item.q}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-2 text-center">
                        <div class="bg-red-50 p-2 rounded">
                            <div class="text-xs text-red-500">You selected</div>
                            <div class="font-bold text-red-700 line-through">${item.selected}</div>
                        </div>
                        <div class="bg-green-50 p-2 rounded">
                            <div class="text-xs text-green-600">Correct</div>
                            <div class="font-bold text-green-700">${item.correct}</div>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
            
            // Scroll to list
            list.scrollIntoView({ behavior: 'smooth' });
            // Hide button after clicking
            document.getElementById('review-btn').classList.add('hidden');
        }

    </script>
</body>
</html>
