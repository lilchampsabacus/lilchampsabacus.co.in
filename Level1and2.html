<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Practice Sums - Level 1 & 2</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed; 
            touch-action: none;

            font-family: 'Nunito', sans-serif;
            background-color: #f0f9ff; 
            background-image: radial-gradient(#e0f2fe 2px, transparent 2px);
            background-size: 24px 24px;
        }

        .sum-table {
            width: 100%;
            max-width: 200px;
            border-collapse: collapse; 
            margin: 0 auto;
            font-family: 'Courier New', Courier, monospace;
        }

        .number-cell {
            text-align: center;
            font-size: 2.5rem; 
            font-weight: 700; 
            padding: 0;
            border-bottom: 1px solid #e5e7eb; 
            color: #374151;
            line-height: 1.1;
        }

        .sum-table tr:last-child .number-cell { border-bottom: 4px solid #1f2937; }
        
        .row-index {
            font-size: 0.7rem;
            color: #9ca3af;
            text-align: right;
            padding-right: 8px;
            width: 30px;
            border: none;
            vertical-align: middle;
        }

        .negative-number { color: #dc2626; } 

        @media (max-height: 700px) {
            .number-cell { font-size: 1.8rem; line-height: 1; }
            .sum-table { max-width: 150px; }
            header, footer { display: none !important; } /* Hide non-essentials */
            .logo-text { font-size: 1rem; }
        }

        .review-card { 
            background: white; 
            border: 1px solid #e5e7eb; 
            border-radius: 8px; 
            overflow: hidden; 
            margin-bottom: 1rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="font-sans text-gray-800">

    <header class="bg-indigo-600 text-white p-3 shadow-md z-10 config-section absolute top-0 w-full">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
        <h1 class="text-xl font-bold text-white">Li'l Champs Abacus</h1>
    </div>
    </header>

    <main class="w-full h-full p-4 flex flex-col items-center config-section overflow-y-auto pt-16">
        <h2 class="text-2xl font-extrabold text-blue-900 mb-4 text-center">Practice Sums</h2>

        <section class="bg-white p-6 rounded-xl shadow-xl w-full max-w-md border-t-4 border-orange-400 text-center mb-10">
            
            <div class="mb-4 hidden"> 
                <input type="text" id="student-identifier-input" class="w-full" readonly>
            </div>

            <div class="inline-block bg-blue-100 text-blue-800 px-4 py-2 rounded-full font-bold mb-6">
                Pilot: <span id="auto-student-name-display">... Loading ...</span>
            </div>

            <div class="mb-4 text-left">
                <label class="block text-sm font-bold text-gray-700 mb-2">1. Select Formula Category</label>
                <select id="category-select" onchange="populateFormulas()" class="w-full p-3 border-2 border-blue-200 rounded-lg bg-gray-50 text-lg font-semibold focus:border-blue-500 outline-none">
                    <option value="">-- Choose Category --</option>
                    <option value="1_sf_add">1. Small Friend (Plus)</option>
                    <option value="2_sf_sub">2. Small Friend (Minus)</option>
                    <option value="3_bf_add">3. Big Friend (Plus)</option>
                    <option value="4_bf_sub">4. Big Friend (Minus)</option>
                    <option value="5_mix_add">5. Mix/Combination (Plus)</option>
                    <option value="6_mix_sub">6. Mix/Combination (Minus)</option>
                </select>
            </div>

            <div class="mb-6 text-left">
                <label class="block text-sm font-bold text-gray-700 mb-2">2. Select Formula</label>
                <select id="formula-select" disabled class="w-full p-3 border-2 border-blue-200 rounded-lg bg-gray-50 text-lg font-semibold disabled:opacity-50 focus:border-blue-500 outline-none">
                    <option value="">-- Select Category First --</option>
                </select>
            </div>

            <div class="mb-8">
                <p class="inline-block bg-blue-50 text-blue-800 font-semibold px-4 py-2 rounded-lg border border-blue-200 shadow-sm">
                    üí° For best result do this 3 times in a row on Abacus.
                </p>
            </div>
            
            <button id="launch-btn" onclick="startGame()" disabled class="w-full bg-green-600 hover:bg-green-700 text-white font-bold text-xl py-4 rounded-full shadow-lg transition-transform transform active:scale-95 disabled:bg-gray-400 disabled:cursor-not-allowed">
                üöÄ Launch Mission
            </button>
        </section>
    </main>

    <div id="game-ui" class="hidden fixed inset-0 bg-white flex flex-col z-50 h-full w-full">
        
        <div class="bg-blue-50 p-2 flex-none flex justify-between items-center border-b border-blue-200 px-4">
            <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Question</span>
            <span class="text-xl font-black text-blue-900"><span id="q-idx">1</span> / 10</span>
        </div>

        <div id="question-area-box" class="flex-grow flex items-center justify-center overflow-hidden bg-white w-full">
            <div id="question-container" class="w-full flex justify-center">
                </div>
        </div>

        <div class="bg-blue-50 p-3 border-t border-blue-200 flex-none pb-safe">
            <div class="max-w-md mx-auto">
                <input type="number" id="answer-input" placeholder="?" 
                       class="w-full p-3 border-2 border-blue-300 rounded-lg text-center text-3xl font-bold focus:outline-none focus:border-blue-600 bg-white mb-3 shadow-inner h-16 transition-colors" 
                       inputmode="numeric" pattern="[0-9]*">
                
                <button id="submit-btn" onclick="submitAnswer()" class="w-full bg-blue-600 text-white font-bold rounded-lg shadow-md text-xl py-3 active:bg-blue-800 transition-colors">
                    Submit Answer
                </button>
            </div>
        </div>
    </div>

    <section id="report-area" class="hidden absolute inset-0 bg-white z-[60] flex flex-col items-center justify-start p-4 overflow-y-auto">
        <div id="report-card" class="bg-white border-4 border-blue-100 p-6 rounded-2xl shadow-2xl max-w-md w-full text-center mb-6 mt-10">
            
            <div class="border-b border-gray-100 pb-4 mb-4">
                <h2 class="text-2xl font-extrabold text-gray-700" id="report-title">Formula Practice</h2>
                <p class="text-sm text-gray-500 mt-1" id="report-formula-name">Formula Name</p>
            </div>

            <h3 class="text-3xl font-black text-blue-800 mb-2">Mission Complete!</h3>
            
            <p class="text-center text-gray-500 mb-6 border-b pb-4">
                <span id="report-datetime"></span> | Agent: <span id="report-student-name" class="font-bold text-blue-600"></span>
            </p>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                    <p class="text-xs text-green-600 uppercase font-bold">Score</p>
                    <p class="text-4xl font-black text-green-700"><span id="score-display">0</span>/10</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-xl border border-purple-200">
                    <p class="text-xs text-purple-600 uppercase font-bold">Time</p>
                    <p class="text-4xl font-black text-purple-800" id="time-display">0:00</p>
                </div>
            </div>
            
            <button onclick="downloadReport()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 mb-3 shadow-lg">‚¨áÔ∏è Download Badge</button>
            
            <button id="review-btn" onclick="showMistakes()" class="w-full bg-red-100 text-red-700 font-bold py-3 rounded-lg mb-3 hidden">
                Review Mistakes
            </button>

            <button onclick="window.location.reload()" class="w-full border-2 border-gray-300 text-gray-600 font-bold py-3 rounded-lg hover:bg-gray-50">üîÑÔ∏è Replay</button>
        </div>

        <div id="wrong-answer-area" class="hidden w-full max-w-md pb-10">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Correction Log</h3>
            <div id="wrong-sums-list" class="flex flex-col gap-4">
                </div>
            <button onclick="hideMistakes()" class="mt-6 w-full bg-gray-600 text-white font-bold py-3 rounded-lg">
                &larr; Back to Report
            </button>
        </div>
    </section>

    <footer class="bg-white text-center p-6 mt-auto border-t border-gray-200 config-section fixed bottom-0 w-full">
        <p class="text-sm text-gray-500">For any queries call <span class="font-bold text-indigo-600">9730482620</span></p>
    </footer>

    <script>
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = 'index.html'; 
        }

        function formatStudentName(identifier) {
            if (!identifier || typeof identifier !== 'string') return 'Pilot';
            const namePart = identifier.split('@')[0];
            return namePart.split('.').map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const nameInput = document.getElementById('student-identifier-input');
            const studentIdentifier = sessionStorage.getItem('studentIdentifier');
            
            if (studentIdentifier) {
                const displayStudentName = formatStudentName(studentIdentifier);
                nameInput.value = studentIdentifier;
                document.getElementById('auto-student-name-display').textContent = displayStudentName;
            }
        });

        const FORMULA_DATA = {
            '1_sf_add': [ 
                { id: 'sf_p4', name: '+4 Formula (+5-1)', trigger: 4, setup: [1,2,3,4] }, 
                { id: 'sf_p3', name: '+3 Formula (+5-2)', trigger: 3, setup: [2,3,4] }, 
                { id: 'sf_p2', name: '+2 Formula (+5-3)', trigger: 2, setup: [3,4] }, 
                { id: 'sf_p1', name: '+1 Formula (+5-4)', trigger: 1, setup: [4] } 
            ],
            '2_sf_sub': [ 
                { id: 'sf_m4', name: '-4 Formula (+1-5)', trigger: -4, setup: [5,6,7,8] }, 
                { id: 'sf_m3', name: '-3 Formula (+2-5)', trigger: -3, setup: [5,6,7] }, 
                { id: 'sf_m2', name: '-2 Formula (+3-5)', trigger: -2, setup: [5,6] }, 
                { id: 'sf_m1', name: '-1 Formula (+4-5)', trigger: -1, setup: [5] } 
            ],
            '3_bf_add': [ 
                { id: 'bf_p9', name: '+9 Formula (-1+10)', trigger: 9, setup: [1,2,3,4, 6,7,8,9] },
                { id: 'bf_p8', name: '+8 Formula (-2+10)', trigger: 8, setup: [2,3,4, 7,8,9] },
                { id: 'bf_p7', name: '+7 Formula (-3+10)', trigger: 7, setup: [3,4, 8,9] },
                { id: 'bf_p6', name: '+6 Formula (-4+10)', trigger: 6, setup: [4, 9] },
                { id: 'bf_p5', name: '+5 Formula (-5+10)', trigger: 5, setup: [5,6,7,8,9] }, 
                { id: 'bf_p4', name: '+4 Formula (-6+10)', trigger: 4, setup: [6,7,8,9] }, 
                { id: 'bf_p3', name: '+3 Formula (-7+10)', trigger: 3, setup: [7,8,9] }, 
                { id: 'bf_p2', name: '+2 Formula (-8+10)', trigger: 2, setup: [8,9] }, 
                { id: 'bf_p1', name: '+1 Formula (-9+10)', trigger: 1, setup: [9] } 
            ],
            '4_bf_sub': [ 
                { id: 'bf_m9', name: '-9 Formula (-10+1)', trigger: -9, setup: [0,1,2,3, 5,6,7,8] },
                { id: 'bf_m8', name: '-8 Formula (-10+2)', trigger: -8, setup: [0,1,2, 5,6,7] },
                { id: 'bf_m7', name: '-7 Formula (-10+3)', trigger: -7, setup: [0,1, 5,6] },
                { id: 'bf_m6', name: '-6 Formula (-10+4)', trigger: -6, setup: [0, 5] },
                { id: 'bf_m5', name: '-5 Formula (-10+5)', trigger: -5, setup: [0,1,2,3,4] }, 
                { id: 'bf_m4', name: '-4 Formula (-10+6)', trigger: -4, setup: [0,1,2,3] }, 
                { id: 'bf_m3', name: '-3 Formula (-10+7)', trigger: -3, setup: [0,1,2] }, 
                { id: 'bf_m2', name: '-2 Formula (-10+8)', trigger: -2, setup: [0,1] }, 
                { id: 'bf_m1', name: '-1 Formula (-10+9)', trigger: -1, setup: [0] } 
            ],
            '5_mix_add': [ 
                { id: 'mix_p6', name: 'Mix +6 (+1-5+10)', trigger: 6, setup: [5,6,7,8] }, 
                { id: 'mix_p7', name: 'Mix +7 (+2-5+10)', trigger: 7, setup: [5,6,7] }, 
                { id: 'mix_p8', name: 'Mix +8 (+3-5+10)', trigger: 8, setup: [5,6] }, 
                { id: 'mix_p9', name: 'Mix +9 (+4-5+10)', trigger: 9, setup: [5] } 
            ],
            '6_mix_sub': [ 
                { id: 'mix_m6', name: 'Mix -6 (-10+5-1)', trigger: -6, setup: [1,2,3,4] }, 
                { id: 'mix_m7', name: 'Mix -7 (-10+5-2)', trigger: -7, setup: [2,3,4] }, 
                { id: 'mix_m8', name: 'Mix -8 (-10+5-3)', trigger: -8, setup: [3,4] }, 
                { id: 'mix_m9', name: 'Mix -9 (-10+5-4)', trigger: -9, setup: [4] } 
            ]
        };

        let currentQuestions = [];
        let currentQIndex = 0;
        let score = 0;
        let startTime;
        let selectedFormulaObj = null;

        function populateFormulas() {
            const cat = document.getElementById('category-select').value;
            const formSelect = document.getElementById('formula-select');
            const btn = document.getElementById('launch-btn');
            formSelect.innerHTML = '<option value="">-- Select Formula --</option>';
            if (cat && FORMULA_DATA[cat]) {
                FORMULA_DATA[cat].forEach(f => {
                    const opt = document.createElement('option');
                    opt.value = f.id; opt.textContent = f.name; formSelect.appendChild(opt);
                });
                formSelect.disabled = false;
            } else { formSelect.disabled = true; }
            btn.disabled = true;
        }

        document.getElementById('formula-select').addEventListener('change', function() {
            document.getElementById('launch-btn').disabled = (this.value === "");
        });

        function isStrictDirectMove(current, val) {
            const unitCurr = current % 10;
            const unitRes = unitCurr + val;
            if (unitRes < 0 || unitRes > 9) return false; 
            const upperBeadCurr = unitCurr >= 5;
            const lowerBeadCurr = unitCurr % 5;
            if (val > 0) {
                const valLower = val % 5;
                const valUpper = val >= 5;
                if (valUpper && upperBeadCurr) return false;
                if (lowerBeadCurr + valLower > 4) return false; 
                return true;
            } else {
                const valAbs = Math.abs(val);
                const valLower = valAbs % 5;
                const valUpper = valAbs >= 5;
                if (valUpper && !upperBeadCurr) return false;
                if (lowerBeadCurr < valLower) return false;
                return true;
            }
        }

        function generateRandomDirect(currentTotal, maxLimit) { 
            const options = [];
            for (let i = -9; i <= 9; i++) {
                if (i === 0) continue;
                if (currentTotal + i < 0) continue;
                if (currentTotal + i > maxLimit) continue;
                if (isStrictDirectMove(currentTotal, i)) options.push(i);
            }
            if (options.length === 0) return 0; 
            return options[Math.floor(Math.random() * options.length)];
        }

        function generateQuestionSet(formulaObj) {
            const MAX_ALLOWED = 99;
            let rows = [], total = 0;
            const NUM_ROWS = 5;
            const triggerIdx = Math.floor(Math.random() * (NUM_ROWS - 1)) + 1; 
            const cat = document.getElementById('category-select').value;
            let startNum;
            const levelIndex = parseInt(cat.charAt(0));
            
            if (levelIndex >= 3) {
                startNum = Math.floor(Math.random() * 51) + 10; 
            } else {
                startNum = Math.floor(Math.random() * 9) + 1;
            }
            rows.push(startNum); total = startNum;

            for (let i = 1; i < triggerIdx; i++) {
                let next = generateRandomDirect(total, MAX_ALLOWED);
                rows.push(next); total += next;
            }

            let lastRow = rows.pop();
            total -= lastRow;
            
            const targetUnit = formulaObj.setup[Math.floor(Math.random() * formulaObj.setup.length)];
            let rangeMin = -9, rangeMax = 9;
            if (levelIndex >= 3) { rangeMin = -19; rangeMax = 19; }

            let validForced = [];
            for(let k=rangeMin; k<=rangeMax; k++) {
                if(k==0) continue;
                if((total + k) < 0) continue; 
                if((total + k) > MAX_ALLOWED) continue;
                if((total + k + formulaObj.trigger) < 0) continue; 
                if((total + k + formulaObj.trigger) > MAX_ALLOWED) continue;

                if((total + k) % 10 === targetUnit) {
                    if(!isStrictDirectMove(total, k)) continue;
                    validForced.push(k);
                }
            }
            
            if(validForced.length === 0) return generateQuestionSet(formulaObj); 
            
            let forcedNum = validForced[Math.floor(Math.random() * validForced.length)];
            rows.push(forcedNum); total += forcedNum;
            rows.push(formulaObj.trigger); total += formulaObj.trigger;
            
            for (let i = triggerIdx + 1; i < NUM_ROWS; i++) {
                 let next = generateRandomDirect(total, MAX_ALLOWED);
                 rows.push(next); total += next;
            }

            return { numbers: rows, answer: total, userAns: null };
        }

        function startGame() {
            const cat = document.getElementById('category-select').value;
            const fid = document.getElementById('formula-select').value;
            selectedFormulaObj = FORMULA_DATA[cat].find(f => f.id === fid);

            currentQuestions = [];
            for(let i=0; i<10; i++) currentQuestions.push(generateQuestionSet(selectedFormulaObj));

            currentQIndex = 0; score = 0; startTime = Date.now();

            document.querySelector('.config-section').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            document.getElementById('game-ui').style.display = 'flex';
            
            renderQuestion();
        }

        function renderQuestion() {
            const qData = currentQuestions[currentQIndex];
            const container = document.getElementById('question-container');
            document.getElementById('q-idx').textContent = currentQIndex + 1;

            let html = '<table class="sum-table">';
            qData.numbers.forEach((num, idx) => {
                const colorClass = num < 0 ? 'negative-number' : '';
                html += `<tr><td class="row-index">${idx+1}</td><td class="number-cell ${colorClass}">${num}</td></tr>`;
            });
            html += '</table>';
            container.innerHTML = html;

            const input = document.getElementById('answer-input');
            input.value = ''; 
            input.disabled = false;
            input.focus();
        }

        function submitAnswer() {
            const input = document.getElementById('answer-input');
            const valStr = input.value.trim();
            
            if (valStr === '') {
                input.focus();
                return; 
            }
            
            const val = parseInt(valStr);

            currentQuestions[currentQIndex].userAns = val;

            if (val === currentQuestions[currentQIndex].answer) {
                score++;
            }

            currentQIndex++;
            if (currentQIndex < 10) {
                renderQuestion();
            } else {
                endGame();
            }
        }

        function endGame() {
            document.getElementById('game-ui').style.display = 'none';
            document.getElementById('report-area').classList.remove('hidden');
            
            const totalTime = Math.floor((Date.now() - startTime) / 1000);
            const mins = Math.floor(totalTime / 60);
            const secs = totalTime % 60;
            const finalTimeString = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            
            const now = new Date();
            const studentIdentifier = sessionStorage.getItem('studentIdentifier');
            const studentName = formatStudentName(studentIdentifier);
            
            document.getElementById('report-datetime').textContent = now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            document.getElementById('report-student-name').textContent = studentName;
            document.getElementById('report-formula-name').textContent = selectedFormulaObj.name;
            document.getElementById('score-display').textContent = score;
            document.getElementById('time-display').textContent = finalTimeString;

            const mistakes = currentQuestions.filter(q => q.userAns !== q.answer);
            const reviewBtn = document.getElementById('review-btn');
            if (mistakes.length > 0) {
                reviewBtn.classList.remove('hidden');
                reviewBtn.textContent = `Review ${mistakes.length} Mistakes`;
            } else {
                reviewBtn.classList.add('hidden');
            }

            const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby9zSp5IW8U_U1UGjgYGKunSOGEqsyo-XJ2ZpjTwdmM-5WF9PRMXTt-bAvYEVfhL7Y8/exec"; 
            if (GOOGLE_SCRIPT_URL) {
                const payload = {
                    name: studentName,
                    formula: "'" + selectedFormulaObj.name,
                    score: score,
                    time: finalTimeString
                };
                fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    mode: "no-cors", 
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                }).catch(err => console.error(err));
            }
        }

        function showMistakes() {
            const container = document.getElementById('wrong-sums-list');
            container.innerHTML = '';
            
            const mistakes = currentQuestions.filter(q => q.userAns !== q.answer);
            
            mistakes.forEach(q => {
                let tableHtml = '<table class="sum-table" style="width:100px; margin-bottom:10px;">';
                q.numbers.forEach((num, idx) => {
                    const colorClass = num < 0 ? 'negative-number' : '';
                    tableHtml += `<tr><td class="number-cell ${colorClass}" style="font-size:1.5rem; border-bottom:1px solid #eee;">${num}</td></tr>`;
                });
                tableHtml += '</table>';

                const card = document.createElement('div');
                card.className = 'review-card p-4 flex flex-col items-center';
                card.innerHTML = `
                    <div class="text-xs font-bold text-gray-400 uppercase mb-2">Correction</div>
                    ${tableHtml}
                    <div class="flex justify-between w-full border-t pt-2 bg-gray-50 px-4 pb-2 mt-2">
                        <div class="text-center">
                            <div class="text-xs text-red-500 font-bold">You Said</div>
                            <div class="text-lg font-bold text-red-600 line-through">${q.userAns}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-green-600 font-bold">Correct</div>
                            <div class="text-lg font-bold text-green-700">${q.answer}</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            document.getElementById('report-card').classList.add('hidden');
            document.getElementById('wrong-answer-area').classList.remove('hidden');
        }

        function hideMistakes() {
            document.getElementById('wrong-answer-area').classList.add('hidden');
            document.getElementById('report-card').classList.remove('hidden');
        }

        function downloadReport() {
            const element = document.getElementById('report-card');
            html2canvas(element).then(canvas => {
                const link = document.createElement('a');
                link.download = `Formula_Report_${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        document.getElementById('answer-input').addEventListener("keypress", function(event) {
            if (event.key === "Enter") { 
                event.preventDefault(); 
                submitAnswer(); 
            }
        });
    </script>
</body>
</html>
