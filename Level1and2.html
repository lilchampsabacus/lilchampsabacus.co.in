<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Practice Sums 1st and 2nd Level</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* --- CORE STYLES --- */
        body { touch-action: manipulation; overscroll-behavior: none; } 

        /* --- TABLE STYLES --- */
        .sum-table {
            width: 100%;
            border-collapse: collapse; 
            margin: 0 auto;
            font-family: 'Courier New', Courier, monospace;
        }

        .number-cell {
            text-align: center;
            font-size: 3rem; /* Larger for better visibility */
            font-weight: 700; 
            padding: 0.2rem 0;
            border-bottom: 1px solid #e5e7eb; 
            color: #374151;
            line-height: 1.1;
        }

        .sum-table tr:last-child .number-cell { border-bottom: 4px solid #1f2937; }
        
        .row-index {
            font-size: 0.8rem;
            color: #9ca3af;
            text-align: right;
            padding-right: 15px;
            width: 40px;
            border: none;
            vertical-align: middle;
        }

        .negative-number { color: #dc2626; } 

        /* --- LAYOUT --- */
        body.focus-mode header, 
        body.focus-mode footer, 
        body.focus-mode .config-section { 
            display: none !important;
        }
        
        body.focus-mode #game-ui {
            display: flex !important;
        }

        .shake { animation: shake 0.3s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body class="bg-blue-50 min-h-screen flex flex-col font-sans">

    <header class="bg-yellow-200 text-black p-4 shadow-md z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-xl sm:text-2xl font-bold">Li'l Champs Abacus Academy</h1>
        </div>
    </header>

    <main class="flex-grow w-full p-4 flex flex-col items-center config-section">
        <h2 class="text-2xl font-extrabold text-blue-900 mb-4 text-center">Practice Sums 1st and 2nd Level</h2>

        <section class="bg-white p-6 rounded-xl shadow-xl w-full max-w-md border-t-4 border-orange-400 text-center">
            
            <div class="mb-6 hidden"> 
                <input type="text" id="student-identifier-input" class="w-full" readonly>
            </div>

            <div class="inline-block bg-blue-100 text-blue-800 px-4 py-2 rounded-full font-bold mb-6">
                Pilot: <span id="auto-student-name-display">... Loading ...</span>
            </div>

            <div class="mb-4 text-left">
                <label class="block text-sm font-bold text-gray-700 mb-2">1. Select Formula for practice</label>
                <select id="category-select" onchange="populateFormulas()" class="w-full p-3 border-2 border-blue-200 rounded-lg bg-gray-50 text-lg font-semibold focus:border-blue-500 outline-none">
                    <option value="">-- Choose Category --</option>
                    <option value="1_sf_add">1. Small Friend (Plus)</option>
                    <option value="2_sf_sub">2. Small Friend (Minus)</option>
                    <option value="3_bf_add">3. Big Friend (Plus)</option>
                    <option value="4_bf_sub">4. Big Friend (Minus)</option>
                    <option value="5_mix_add">5. Mix/Combination (Plus)</option>
                    <option value="6_mix_sub">6. Mix/Combination (Minus)</option>
                </select>
            </div>

            <div class="mb-6 text-left">
                <label class="block text-sm font-bold text-gray-700 mb-2">2. Select Formula</label>
                <select id="formula-select" disabled class="w-full p-3 border-2 border-blue-200 rounded-lg bg-gray-50 text-lg font-semibold disabled:opacity-50 focus:border-blue-500 outline-none">
                    <option value="">-- Select Category First --</option>
                </select>
            </div>
            
            <button id="launch-btn" onclick="startGame()" disabled class="w-full bg-green-600 hover:bg-green-700 text-white font-bold text-xl py-4 rounded-full shadow-lg transition-transform transform active:scale-95 disabled:bg-gray-400 disabled:cursor-not-allowed">
                ðŸš€ Launch Mission
            </button>
        </section>
    </main>

    <div id="game-ui" class="hidden fixed inset-0 bg-white flex-col z-50">
        
        <div class="bg-blue-100 p-2 text-center border-b border-blue-200 flex-none">
            <span class="text-blue-900 font-bold uppercase tracking-widest text-sm">
                Question <span id="q-idx" class="text-lg">1</span> / 10
            </span>
        </div>

        <div id="question-area-box" class="flex-grow flex items-center justify-center overflow-y-auto bg-white p-2">
            <div id="question-container" class="w-full max-w-sm">
                </div>
        </div>

        <div id="feedback-msg" class="h-8 text-center font-bold text-lg flex-none flex items-center justify-center"></div>

        <div class="bg-blue-50 p-3 border-t border-blue-200 flex-none pb-safe">
            <div class="max-w-md mx-auto">
                <input type="number" id="answer-input" placeholder="?" 
                       class="w-full p-3 border-2 border-blue-300 rounded-lg text-center text-4xl font-bold focus:outline-none focus:border-blue-600 bg-white mb-3 shadow-inner" 
                       inputmode="numeric" pattern="[0-9]*">
                
                <div class="flex gap-2 h-14">
                    <button id="check-btn" onclick="handleAction()" class="w-1/2 bg-blue-600 text-white font-bold rounded-lg shadow-md text-xl active:bg-blue-800 transition-colors">
                        Check
                    </button>
                    <button id="next-btn" onclick="nextQuestion()" class="w-1/2 bg-gray-400 text-white font-bold rounded-lg shadow-md text-xl active:bg-gray-600 transition-colors">
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>

    <section id="report-area" class="hidden flex-grow flex justify-center items-center p-4">
        <div id="report-card" class="bg-white border-4 border-blue-100 p-6 rounded-2xl shadow-2xl max-w-md w-full text-center">
            
            <div class="border-b border-gray-100 pb-4 mb-4">
                <h2 class="text-2xl font-extrabold text-gray-700" id="report-title">Formula Practice</h2>
                <p class="text-sm text-gray-500 mt-1" id="report-formula-name">Formula Name</p>
            </div>

            <h3 class="text-3xl font-black text-blue-800 mb-2">Mission Complete!</h3>
            
            <p class="text-center text-gray-500 mb-6 border-b pb-4">
                <span id="report-datetime"></span> | Agent: <span id="report-student-name" class="font-bold text-blue-600"></span>
            </p>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                    <p class="text-xs text-green-600 uppercase font-bold">Score</p>
                    <p class="text-4xl font-black text-green-700"><span id="score-display">0</span>/10</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-xl border border-purple-200">
                    <p class="text-xs text-purple-600 uppercase font-bold">Time</p>
                    <p class="text-4xl font-black text-purple-800" id="time-display">0:00</p>
                </div>
            </div>
            
            <button onclick="downloadReport()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 mb-3 shadow-lg">ðŸ“¥ Download Badge</button>
            <button onclick="window.location.reload()" class="w-full border-2 border-gray-300 text-gray-600 font-bold py-3 rounded-lg hover:bg-gray-50">ðŸ”„ Replay</button>
        </div>
    </section>

    <footer class="bg-yellow-200 text-center p-3 mt-auto config-section">
        <p class="text-sm font-semibold text-yellow-900">Contact: 9730482620</p>
    </footer>

    <script>
        // --- 1. STRICT LOGIN ENFORCEMENT ---
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = 'index.html'; 
        }

        function formatStudentName(identifier) {
            if (!identifier || typeof identifier !== 'string') return 'Pilot';
            const namePart = identifier.split('@')[0];
            return namePart.split('.').map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const nameInput = document.getElementById('student-identifier-input');
            const studentIdentifier = sessionStorage.getItem('studentIdentifier');
            
            if (studentIdentifier) {
                const displayStudentName = formatStudentName(studentIdentifier);
                nameInput.value = studentIdentifier;
                document.getElementById('auto-student-name-display').textContent = displayStudentName;
            }
        });

        // --- 2. FORMULA DATA ---
        const FORMULA_DATA = {
            '1_sf_add': [ 
                { id: 'sf_p4', name: '+4 Formula (+5-1)', trigger: 4, setup: [1,2,3,4] }, 
                { id: 'sf_p3', name: '+3 Formula (+5-2)', trigger: 3, setup: [2,3,4] }, 
                { id: 'sf_p2', name: '+2 Formula (+5-3)', trigger: 2, setup: [3,4] }, 
                { id: 'sf_p1', name: '+1 Formula (+5-4)', trigger: 1, setup: [4] } 
            ],
            '2_sf_sub': [ 
                { id: 'sf_m4', name: '-4 Formula (+1-5)', trigger: -4, setup: [5,6,7,8] }, 
                { id: 'sf_m3', name: '-3 Formula (+2-5)', trigger: -3, setup: [5,6,7] }, 
                { id: 'sf_m2', name: '-2 Formula (+3-5)', trigger: -2, setup: [5,6] }, 
                { id: 'sf_m1', name: '-1 Formula (+4-5)', trigger: -1, setup: [5] } 
            ],
            '3_bf_add': [ 
                { id: 'bf_p9', name: '+9 Formula (-1+10)', trigger: 9, setup: [1,2,3,4, 6,7,8,9] },
                { id: 'bf_p8', name: '+8 Formula (-2+10)', trigger: 8, setup: [2,3,4, 7,8,9] },
                { id: 'bf_p7', name: '+7 Formula (-3+10)', trigger: 7, setup: [3,4, 8,9] },
                { id: 'bf_p6', name: '+6 Formula (-4+10)', trigger: 6, setup: [4, 9] },
                { id: 'bf_p5', name: '+5 Formula (-5+10)', trigger: 5, setup: [5,6,7,8,9] }, 
                { id: 'bf_p4', name: '+4 Formula (-6+10)', trigger: 4, setup: [6,7,8,9] }, 
                { id: 'bf_p3', name: '+3 Formula (-7+10)', trigger: 3, setup: [7,8,9] }, 
                { id: 'bf_p2', name: '+2 Formula (-8+10)', trigger: 2, setup: [8,9] }, 
                { id: 'bf_p1', name: '+1 Formula (-9+10)', trigger: 1, setup: [9] } 
            ],
            '4_bf_sub': [ 
                { id: 'bf_m9', name: '-9 Formula (-10+1)', trigger: -9, setup: [0,1,2,3, 5,6,7,8] },
                { id: 'bf_m8', name: '-8 Formula (-10+2)', trigger: -8, setup: [0,1,2, 5,6,7] },
                { id: 'bf_m7', name: '-7 Formula (-10+3)', trigger: -7, setup: [0,1, 5,6] },
                { id: 'bf_m6', name: '-6 Formula (-10+4)', trigger: -6, setup: [0, 5] },
                { id: 'bf_m5', name: '-5 Formula (-10+5)', trigger: -5, setup: [0,1,2,3,4] }, 
                { id: 'bf_m4', name: '-4 Formula (-10+6)', trigger: -4, setup: [0,1,2,3] }, 
                { id: 'bf_m3', name: '-3 Formula (-10+7)', trigger: -3, setup: [0,1,2] }, 
                { id: 'bf_m2', name: '-2 Formula (-10+8)', trigger: -2, setup: [0,1] }, 
                { id: 'bf_m1', name: '-1 Formula (-10+9)', trigger: -1, setup: [0] } 
            ],
            '5_mix_add': [ 
                { id: 'mix_p6', name: 'Mix +6 (+1-5+10)', trigger: 6, setup: [5,6,7,8] }, 
                { id: 'mix_p7', name: 'Mix +7 (+2-5+10)', trigger: 7, setup: [5,6,7] }, 
                { id: 'mix_p8', name: 'Mix +8 (+3-5+10)', trigger: 8, setup: [5,6] }, 
                { id: 'mix_p9', name: 'Mix +9 (+4-5+10)', trigger: 9, setup: [5] } 
            ],
            '6_mix_sub': [ 
                { id: 'mix_m6', name: 'Mix -6 (-10+5-1)', trigger: -6, setup: [1,2,3,4] }, 
                { id: 'mix_m7', name: 'Mix -7 (-10+5-2)', trigger: -7, setup: [2,3,4] }, 
                { id: 'mix_m8', name: 'Mix -8 (-10+5-3)', trigger: -8, setup: [3,4] }, 
                { id: 'mix_m9', name: 'Mix -9 (-10+5-4)', trigger: -9, setup: [4] } 
            ]
        };

        let currentQuestions = [], currentQIndex = 0, score = 0, startTime, selectedFormulaObj = null;

        function populateFormulas() {
            const cat = document.getElementById('category-select').value;
            const formSelect = document.getElementById('formula-select');
            const btn = document.getElementById('launch-btn');
            formSelect.innerHTML = '<option value="">-- Select Formula --</option>';
            if (cat && FORMULA_DATA[cat]) {
                FORMULA_DATA[cat].forEach(f => {
                    const opt = document.createElement('option');
                    opt.value = f.id; opt.textContent = f.name; formSelect.appendChild(opt);
                });
                formSelect.disabled = false;
            } else { formSelect.disabled = true; }
            btn.disabled = true;
        }

        document.getElementById('formula-select').addEventListener('change', function() {
            document.getElementById('launch-btn').disabled = (this.value === "");
        });

        // --- 3. LOGIC (No changes to math logic) ---
        function isStrictDirectMove(current, val) {
            const unitCurr = current % 10;
            const unitRes = unitCurr + val;
            if (unitRes < 0 || unitRes > 9) return false; 
            const upperBeadCurr = unitCurr >= 5;
            const lowerBeadCurr = unitCurr % 5;
            if (val > 0) {
                const valLower = val % 5;
                const valUpper = val >= 5;
                if (valUpper && upperBeadCurr) return false;
                if (lowerBeadCurr + valLower > 4) return false; 
                return true;
            } else {
                const valAbs = Math.abs(val);
                const valLower = valAbs % 5;
                const valUpper = valAbs >= 5;
                if (valUpper && !upperBeadCurr) return false;
                if (lowerBeadCurr < valLower) return false;
                return true;
            }
        }

        function generateRandomDirect(currentTotal) {
            const options = [];
            for (let i = -9; i <= 9; i++) {
                if (i === 0) continue;
                if (currentTotal + i < 0) continue;
                if (isStrictDirectMove(currentTotal, i)) options.push(i);
            }
            if (options.length === 0) return 0; 
            return options[Math.floor(Math.random() * options.length)];
        }

        function generateQuestionSet(formulaObj) {
            let rows = [], total = 0;
            const NUM_ROWS = 5; 
            const triggerIdx = Math.floor(Math.random() * (NUM_ROWS - 1)) + 1; 
            const cat = document.getElementById('category-select').value;
            let startNum;
            const levelIndex = parseInt(cat.charAt(0));
            if (levelIndex >= 3) {
                startNum = Math.floor(Math.random() * 89) + 10; 
            } else {
                startNum = Math.floor(Math.random() * 9) + 1;
            }
            rows.push(startNum); total = startNum;
            for (let i = 1; i < triggerIdx; i++) {
                let next = generateRandomDirect(total);
                rows.push(next); total += next;
            }
            let lastRow = rows.pop();
            total -= lastRow;
            const targetUnit = formulaObj.setup[Math.floor(Math.random() * formulaObj.setup.length)];
            let rangeMin = -9, rangeMax = 9;
            if (levelIndex >= 3) { rangeMin = -19; rangeMax = 19; }
            let validForced = [];
            for(let k=rangeMin; k<=rangeMax; k++) {
                if(k==0) continue;
                if((total + k) < 0) continue; 
                if((total + k + formulaObj.trigger) < 0) continue; 
                if((total + k) % 10 === targetUnit) {
                    if(!isStrictDirectMove(total, k)) continue;
                    validForced.push(k);
                }
            }
            if(validForced.length === 0) return generateQuestionSet(formulaObj); 
            let forcedNum = validForced[Math.floor(Math.random() * validForced.length)];
            rows.push(forcedNum); total += forcedNum;
            rows.push(formulaObj.trigger); total += formulaObj.trigger;
            for (let i = triggerIdx + 1; i < NUM_ROWS; i++) {
                 let next = generateRandomDirect(total);
                 rows.push(next); total += next;
            }
            return { numbers: rows, answer: total };
        }

        function startGame() {
            const cat = document.getElementById('category-select').value;
            const fid = document.getElementById('formula-select').value;
            selectedFormulaObj = FORMULA_DATA[cat].find(f => f.id === fid);
            
            document.body.classList.add('focus-mode');
            const gameUi = document.getElementById('game-ui');
            gameUi.classList.remove('hidden');
            gameUi.style.display = "flex";

            currentQuestions = [];
            for(let i=0; i<10; i++) currentQuestions.push(generateQuestionSet(selectedFormulaObj));

            currentQIndex = 0; score = 0; startTime = Date.now();
            renderQuestion();
        }

        function renderQuestion() {
            const qData = currentQuestions[currentQIndex];
            const container = document.getElementById('question-container');
            document.getElementById('q-idx').textContent = currentQIndex + 1;
            
            let html = '<table class="sum-table">';
            qData.numbers.forEach((num, idx) => {
                const colorClass = num < 0 ? 'negative-number' : '';
                html += `<tr><td class="row-index">${idx+1}</td><td class="number-cell ${colorClass}">${num}</td></tr>`;
            });
            html += '</table>';
            container.innerHTML = html;
            
            const input = document.getElementById('answer-input');
            input.value = ''; 
            input.focus();
            
            // Reset Styles
            document.getElementById('feedback-msg').textContent = '';
            input.classList.remove('bg-green-50', 'border-green-500', 'bg-red-50', 'border-red-500');
            
            const checkBtn = document.getElementById('check-btn');
            checkBtn.disabled = false;
        }

        function handleAction() {
            const input = document.getElementById('answer-input');
            const val = parseInt(input.value);
            if (isNaN(val)) return;
            const correct = currentQuestions[currentQIndex].answer;
            const feedback = document.getElementById('feedback-msg');
            const checkBtn = document.getElementById('check-btn');

            if (val === correct) {
                score++;
                feedback.textContent = "Correct! ðŸŽ‰";
                feedback.className = "text-green-600 font-bold text-lg h-8 flex items-center justify-center";
                input.classList.add('bg-green-50', 'border-green-500');
                
                // Disable check button so they can't double click
                checkBtn.disabled = true;

                // AUTO ADVANCE AFTER 800ms
                setTimeout(() => {
                    nextQuestion();
                }, 800);

            } else {
                feedback.innerHTML = `Wrong. Ans: <span class="text-black">${correct}</span>`;
                feedback.className = "text-red-500 font-bold text-lg h-8 flex items-center justify-center shake";
                input.classList.add('bg-red-50', 'border-red-500');
                // For wrong answers, user must click Next manually
            }
        }

        function nextQuestion() {
            const input = document.getElementById('answer-input');
            input.classList.remove('bg-green-50', 'border-green-500', 'bg-red-50', 'border-red-500');
            currentQIndex++;
            if (currentQIndex < 10) renderQuestion(); else endGame();
        }

        function endGame() {
            document.body.classList.remove('focus-mode');
            document.getElementById('game-ui').style.display = 'none';
            document.getElementById('report-area').classList.remove('hidden');
            
            const totalTime = Math.floor((Date.now() - startTime) / 1000);
            const mins = Math.floor(totalTime / 60);
            const secs = totalTime % 60;
            const finalTimeString = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            
            const now = new Date();
            const dateTimeStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const studentIdentifier = sessionStorage.getItem('studentIdentifier');
            const studentName = formatStudentName(studentIdentifier);
            
            document.getElementById('report-datetime').textContent = dateTimeStr;
            document.getElementById('report-student-name').textContent = studentName;
            document.getElementById('report-formula-name').textContent = selectedFormulaObj.name;
            document.getElementById('score-display').textContent = score;
            document.getElementById('time-display').textContent = finalTimeString;

            const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby9zSp5IW8U_U1UGjgYGKunSOGEqsyo-XJ2ZpjTwdmM-5WF9PRMXTt-bAvYEVfhL7Y8/exec"; 

            if (GOOGLE_SCRIPT_URL) {
                const payload = {
                    name: studentName,
                    formula: "'" + selectedFormulaObj.name,
                    score: score,
                    time: finalTimeString
                };

                fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    mode: "no-cors", 
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                }).then(() => {
                    console.log("Data sent");
                    const reportTitle = document.getElementById('report-title');
                    if (!reportTitle.innerText.includes("Saved")) {
                        reportTitle.innerText = reportTitle.innerText + " (Saved â˜ï¸)";
                    }
                }).catch(err => console.error(err));
            }
        }

        function downloadReport() {
            const element = document.getElementById('report-card');
            html2canvas(element).then(canvas => {
                const link = document.createElement('a');
                link.download = `Formula_Report_${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }
        
        document.getElementById('answer-input').addEventListener("keypress", function(event) {
            if (event.key === "Enter") { 
                event.preventDefault(); 
                document.getElementById("check-btn").click(); 
            }
        });
    </script>
</body>
</html>
