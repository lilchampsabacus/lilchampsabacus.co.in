<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Reports V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>body { font-family: 'Nunito', sans-serif; background-color: #f0f9ff; }</style>
</head>
<body class="p-6 md:p-10">

    <div class="max-w-6xl mx-auto flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-extrabold text-gray-800">Student Reports</h1>
            <p class="text-indigo-600 font-semibold">Select a student to view their progress</p>
        </div>
        <a href="teacher-dashboard.html" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg">‚Üê Back</a>
    </div>

    <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-lg p-6 mb-8 border border-indigo-100">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">Select Student</label>
                <div class="relative">
                    <select id="studentDropdown" class="block appearance-none w-full bg-indigo-50 border border-indigo-200 text-gray-700 py-3 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-indigo-500">
                        <option value="">Status: Loading...</option>
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">Filter Month</label>
                <input type="month" id="monthPicker" class="w-full bg-gray-50 border border-gray-200 text-gray-700 py-3 px-4 rounded-lg focus:outline-none focus:border-indigo-500">
            </div>
            <div class="flex items-end">
                <button onclick="getReport()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all">Show Report</button>
            </div>
        </div>
    </div>

    <div id="graphArea" class="max-w-6xl mx-auto mb-8 hidden">
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
            <h3 class="text-lg font-bold text-gray-800 mb-4">üìä Practice Distribution</h3>
            <div class="h-64 w-full">
                <canvas id="practiceChart"></canvas>
            </div>
        </div>
    </div>

    <div id="calendarArea" class="max-w-6xl mx-auto mb-8 hidden">
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                üìÖ Monthly Consistency
                <span class="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded">Green = Practiced</span>
                <span class="text-xs font-normal text-red-500 bg-red-50 px-2 py-1 rounded">Red = Missed</span>
            </h3>
            <div class="grid grid-cols-7 gap-1 mb-2 text-center text-xs font-bold text-gray-400 uppercase">
                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>
            <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
        </div>
    </div>

    <div id="resultsArea" class="max-w-6xl mx-auto hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow border-l-4 border-blue-500">
                <h3 class="text-gray-500 text-sm font-bold uppercase">Total Practices</h3>
                <p id="totalCount" class="text-3xl font-extrabold text-blue-600">0</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow border-l-4 border-purple-500">
                <h3 class="text-gray-500 text-sm font-bold uppercase">Last Active</h3>
                <p id="lastActive" class="text-xl font-bold text-purple-600">-</p>
            </div>
        </div>

        <div class="bg-white shadow-lg rounded-2xl overflow-hidden">
            <table class="min-w-full leading-normal">
                <thead>
                    <tr>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Type</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Score</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Time Taken</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://ipakwgzbbjywzccoahiw.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwYWt3Z3piYmp5d3pjY29haGl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxOTAyMjQsImV4cCI6MjA3Nzc2NjIyNH0.VNjAhpbMzv9c19-IAg8UF2u28aIhh5OYCjAhcec9dRk";
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let myChart = null; // Store chart instance to destroy/redraw

        // --- HELPERS ---
        function getRawDate(isoString) {
            if (!isoString) return "-";
            const cleanDate = isoString.split('T')[0].split(' ')[0]; 
            const [year, month, day] = cleanDate.split('-');
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            return `${day} ${months[parseInt(month)-1]} ${year}`;
        }

        function getRawTime(isoString) {
            if (!isoString) return "-";
            let timePart = "";
            if(isoString.includes('T')) timePart = isoString.split('T')[1];
            else if(isoString.includes(' ')) timePart = isoString.split(' ')[1];
            else return "-";

            timePart = timePart.split('+')[0].split('Z')[0].split('.')[0];
            let [hours, minutes] = timePart.split(':');
            let h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12; h = h ? h : 12; 
            return `${h}:${minutes} ${ampm}`;
        }

        function formatTimeTaken(input) {
            if (!input) return "-";
            if (typeof input === 'string' && input.includes(':')) return input + " m";
            const s = parseInt(input);
            if (isNaN(s)) return input;
            const mins = Math.floor(s / 60);
            const secs = s % 60;
            if (mins > 0) return `${mins}m ${secs}s`;
            return `${secs}s`;
        }

        // --- STARTUP ---
        document.addEventListener('DOMContentLoaded', async () => {
            const dropdown = document.getElementById('studentDropdown');
            dropdown.innerHTML = '<option>Loading...</option>';
            
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                dropdown.innerHTML = '<option>Error: No Session</option>';
                alert("You are not logged in! Please go back to login page.");
                return;
            }

            const { data, error } = await supabase.from('reports').select('student_name');
            if (error) { dropdown.innerHTML = '<option>Error</option>'; return; }
            if (!data || data.length === 0) { dropdown.innerHTML = '<option>No students</option>'; return; }

            const uniqueNames = [...new Set(data.map(item => item.student_name))];
            dropdown.innerHTML = '<option value="">-- Choose a Student --</option>';
            uniqueNames.sort().forEach(name => {
                if(name) { 
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    dropdown.appendChild(option);
                }
            });
            
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('monthPicker').value = `${yyyy}-${mm}`;
        });

        // --- FETCH DATA ---
        async function getReport() {
            const studentName = document.getElementById('studentDropdown').value;
            if(!studentName) { alert("Please select a student first!"); return; }

            document.getElementById('resultsArea').classList.add('hidden');
            document.getElementById('calendarArea').classList.add('hidden');
            document.getElementById('graphArea').classList.add('hidden');
            
            const { data: reports, error } = await supabase
                .from('reports')
                .select('*')
                .eq('student_name', studentName)
                .order('indian_time', { ascending: false });

            if(error) { alert("Error: " + error.message); return; }
            
            if(reports) {
                renderTable(reports);
                renderCalendar(reports);
                renderGraph(reports); // DRAW THE GRAPH!
            }
        }

        // --- NEW: RENDER GRAPH ---
        function renderGraph(reports) {
            document.getElementById('graphArea').classList.remove('hidden');
            
            let counts = {
                plusMinus: 0,
                multi: 0,
                division: 0
            };

            // Calculate Counts based on Challenge Type keywords
            reports.forEach(r => {
                const type = (r.challenge_type || "").toLowerCase();
                
                if (type.includes('row') || type.includes('digit') || type.includes('plus')) {
                    counts.plusMinus++;
                } else if (type.includes('by') || type.includes('x') || type.includes('multi')) {
                    counts.multi++;
                } else if (type.includes('div') || type.includes('/')) {
                    counts.division++;
                } else {
                    // Fallback: usually if it's just numbers, might be flash cards, ignore for now
                }
            });

            // Destroy old chart if exists
            if (myChart) myChart.destroy();

            const ctx = document.getElementById('practiceChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Plus & Minus', 'Multiplication', 'Division'],
                    datasets: [{
                        label: 'Number of Practices',
                        data: [counts.plusMinus, counts.multi, counts.division],
                        backgroundColor: [
                            'rgba(245, 158, 11, 0.7)', // Orange for Plus Minus
                            'rgba(59, 130, 246, 0.7)', // Blue for Multi
                            'rgba(139, 92, 246, 0.7)'  // Purple for Division
                        ],
                        borderColor: [
                            'rgba(245, 158, 11, 1)',
                            'rgba(59, 130, 246, 1)',
                            'rgba(139, 92, 246, 1)'
                        ],
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { display: false } },
                        x: { grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // --- RENDER TABLE ---
        function renderTable(reports) {
            document.getElementById('resultsArea').classList.remove('hidden');
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = '';
            
            let count = 0;
            reports.forEach(row => {
                const dateStr = getRawDate(row.indian_time);
                const timeStr = getRawTime(row.indian_time);
                count++;
                const timeTaken = row.time_taken || row.duration || row.timer || 0;

                const tr = `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-5 py-4 text-sm">
                            <p class="font-bold text-gray-900">${dateStr}</p>
                            <p class="text-xs text-gray-500">${timeStr}</p>
                        </td>
                        <td class="px-5 py-4 text-sm capitalize text-gray-600">${row.challenge_type || 'Practice'}</td>
                        <td class="px-5 py-4 text-sm font-bold text-indigo-600">${row.score_text || row.score}</td>
                        <td class="px-5 py-4 text-sm font-bold text-gray-700">‚è±Ô∏è ${formatTimeTaken(timeTaken)}</td>
                    </tr>`;
                tbody.innerHTML += tr;
            });
            document.getElementById('totalCount').innerText = count;
            document.getElementById('lastActive').innerText = reports.length > 0 ? getRawDate(reports[0].indian_time) : 'N/A';
        }

        // --- RENDER CALENDAR ---
        function renderCalendar(reports) {
            const calendarArea = document.getElementById('calendarArea');
            const grid = document.getElementById('calendarGrid');
            const monthInput = document.getElementById('monthPicker').value;
            calendarArea.classList.remove('hidden');
            grid.innerHTML = '';

            let date = new Date();
            if (monthInput) {
                const [y, m] = monthInput.split('-');
                date = new Date(y, m - 1, 1);
            }
            const year = date.getFullYear();
            const month = date.getMonth(); 

            const practiceDates = new Set();
            reports.forEach(r => {
                if(!r.indian_time) return;
                const cleanDate = r.indian_time.split('T')[0].split(' ')[0];
                const [rYear, rMonth, rDay] = cleanDate.split('-').map(Number);
                if ((rMonth - 1) === month && rYear === year) {
                     practiceDates.add(cleanDate);
                }
            });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += `<div class="h-12 bg-gray-50 rounded-lg"></div>`;
            }

            const now = new Date();
            const todayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;

            for (let day = 1; day <= daysInMonth; day++) {
                const currentMonth = (month + 1).toString().padStart(2, '0');
                const currentDay = day.toString().padStart(2, '0');
                const checkDate = `${year}-${currentMonth}-${currentDay}`;
                const isPracticed = practiceDates.has(checkDate);
                
                let colorClass = "bg-white border-gray-100 text-gray-300"; 
                if (isPracticed) colorClass = "bg-green-100 border-green-300 text-green-700 shadow-sm";
                else if (checkDate < todayStr && checkDate >= `${year}-${currentMonth}-01`) colorClass = "bg-red-50 border-red-100 text-red-400";

                grid.innerHTML += `<div class="h-12 border-2 rounded-lg flex items-center justify-center font-bold text-sm ${colorClass}">${day}${isPracticed ? '<span class="ml-1 text-xs">‚úÖ</span>' : ''}</div>`;
            }
        }
    </script>
</body>
</html>
