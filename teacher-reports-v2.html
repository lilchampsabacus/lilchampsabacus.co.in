<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Reports V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* WEB FONTS */
        body { font-family: 'Nunito', sans-serif; background-color: #f0f9ff; }
        
        /* --- PDF SPECIFIC STYLES --- */
        .pdf-mode {
            background-color: #f0f9ff !important; 
            width: 1024px !important; /* Scaled down width */
            max-width: 1024px !important;
            margin: 0 auto !important;
            padding: 30px !important;
            font-family: Arial, Helvetica, sans-serif !important;
            color: #333 !important;
        }

        .pdf-mode .no-print { display: none !important; }

        .pdf-mode .shadow-lg {
            box-shadow: none !important;
            border: 2px solid #cbd5e1 !important;
            border-radius: 8px !important;
        }

        /* LAYOUT GRID */
        .pdf-mode .pdf-row {
            display: flex !important;
            gap: 20px !important;
            margin-bottom: 20px !important;
            align-items: stretch !important;
        }
        .pdf-mode .pdf-col-calendar { width: 55% !important; }
        .pdf-mode .pdf-col-graph { width: 45% !important; }

        /* HEADER */
        .pdf-mode header {
            border-bottom: 3px solid #2563eb !important;
            margin-bottom: 25px !important;
            padding-bottom: 15px !important;
        }

        /* TABLE STYLING */
        .pdf-mode table { font-size: 12px !important; background-color: white !important; }
        .pdf-mode th { background-color: #e5e7eb !important; color: #111 !important; border-bottom: 2px solid #9ca3af !important; }
        .pdf-mode td { border-bottom: 1px solid #e5e7eb !important; }

        /* --- THE FIX: FORCE TABLE TO PAGE 2 --- */
        .pdf-mode #tableContainer {
            page-break-before: always !important; /* Forces new page */
            margin-top: 0 !important;
        }

        /* AVOID CUTS */
        .avoid-break { page-break-inside: avoid; break-inside: avoid; }
        tr { page-break-inside: avoid; break-inside: avoid; }
        
        .pdf-mode .chart-container { height: 260px !important; }
    </style>
</head>
<body class="p-6 md:p-10">

    <div class="max-w-7xl mx-auto flex justify-between items-center mb-8" id="webHeader">
        <div>
            <h1 class="text-3xl font-extrabold text-gray-800">Student Reports</h1>
            <p class="text-indigo-600 font-semibold">Select a student and date range.</p>
        </div>
        <a href="teacher-dashboard.html" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg">‚Üê Back</a>
    </div>

    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-lg p-6 mb-8 border border-indigo-100" id="controlsBox">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">Select Student</label>
                <div class="relative">
                    <select id="studentDropdown" class="block appearance-none w-full bg-indigo-50 border border-indigo-200 text-gray-700 py-3 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-indigo-500">
                        <option value="">Status: Loading...</option>
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">Start Date</label>
                <input type="date" id="startDate" class="w-full bg-gray-50 border border-gray-200 text-gray-700 py-3 px-4 rounded-lg">
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">End Date</label>
                <input type="date" id="endDate" class="w-full bg-gray-50 border border-gray-200 text-gray-700 py-3 px-4 rounded-lg">
            </div>
            <div>
                <button onclick="getReport()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all">Show Report</button>
            </div>
            <div>
                <button onclick="downloadPDF()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all flex justify-center items-center gap-2">
                    <span>‚¨áÔ∏è</span> PDF
                </button>
            </div>
        </div>
    </div>

    <div id="printableArea" class="max-w-7xl mx-auto">

        <header id="pdfHeader" class="hidden text-left mb-6">
            <div class="flex justify-between items-end">
                <div>
                    <h1 class="text-4xl font-extrabold text-indigo-900 leading-tight">Li'l Champs Abacus Academy</h1>
                    <h2 class="text-xl text-gray-600 font-bold tracking-wide mt-2">Student Performance Report</h2>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-500 font-semibold">Generated: <span id="pdfGenDate" class="text-gray-800"></span></p>
                    <p class="text-sm text-gray-500 font-semibold">Student: <span id="pdfStudentName" class="font-extrabold text-blue-700 text-xl"></span></p>
                </div>
            </div>
        </header>

        <div id="pageOneContent">
            <div id="resultsArea" class="hidden mb-6 avoid-break">
                <div class="bg-white rounded-xl border-2 border-indigo-100 p-5 flex justify-between items-center shadow-sm">
                    <div class="text-center w-1/3 border-r-2 border-gray-200">
                        <p class="text-xs font-bold text-gray-500 uppercase tracking-wider">Total Practices</p>
                        <p id="totalCount" class="text-4xl font-extrabold text-blue-700 mt-1">0</p>
                    </div>
                    <div class="text-center w-1/3 border-r-2 border-gray-200">
                        <p class="text-xs font-bold text-gray-500 uppercase tracking-wider">Date Range</p>
                        <p id="pdfDateRange" class="text-lg font-bold text-gray-700 mt-1">All Time</p>
                    </div>
                    <div class="text-center w-1/3">
                        <p class="text-xs font-bold text-gray-500 uppercase tracking-wider">Last Active</p>
                        <p id="lastActive" class="text-xl font-bold text-purple-700 mt-1">-</p>
                    </div>
                </div>
            </div>

            <div class="pdf-row-container hidden md:block">
                <div class="flex flex-col md:flex-row gap-6 mb-6">
                    
                    <div id="calendarArea" class="bg-white rounded-2xl shadow-lg p-5 border border-gray-100 flex-1 md:w-[60%] avoid-break">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center gap-3">
                                <h3 class="text-lg font-bold text-gray-800">üìÖ Consistency</h3>
                                <input type="month" id="monthPicker" onchange="updateCalendarOnly()" class="no-print bg-gray-50 border border-gray-200 text-gray-700 py-1 px-2 rounded text-xs font-bold">
                                <span id="pdfMonthLabel" class="hidden font-extrabold text-gray-700 text-lg"></span>
                            </div>
                            <div class="flex gap-2 text-[10px] font-bold">
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded border border-green-200">‚úî Practiced</span>
                                <span class="bg-red-50 text-red-600 px-2 py-1 rounded border border-red-200">‚úñ Missed</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-7 gap-1 mb-1 text-center text-xs font-bold text-gray-400 uppercase">
                            <div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div>
                        </div>
                        <div id="calendarGrid" class="grid grid-cols-7 gap-1"></div>
                    </div>

                    <div id="graphArea" class="bg-white rounded-2xl shadow-lg p-5 border border-gray-100 flex-1 md:w-[40%] avoid-break">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">üìä Distribution</h3>
                        <div class="chart-container w-full h-64">
                            <canvas id="practiceChart"></canvas>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div id="tableContainer" class="bg-white shadow-lg rounded-2xl overflow-hidden hidden mt-4 border border-gray-300">
            <h3 class="text-lg font-bold text-gray-800 p-4 border-b border-gray-200 bg-gray-50">Detailed History</h3>
            <table class="min-w-full leading-normal">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="px-5 py-3 border-b-2 border-gray-300 text-left text-xs font-extrabold text-gray-700 uppercase tracking-wider">Date</th>
                        <th class="px-5 py-3 border-b-2 border-gray-300 text-left text-xs font-extrabold text-gray-700 uppercase tracking-wider">Type</th>
                        <th class="px-5 py-3 border-b-2 border-gray-300 text-left text-xs font-extrabold text-gray-700 uppercase tracking-wider">Score</th>
                        <th class="px-5 py-3 border-b-2 border-gray-300 text-left text-xs font-extrabold text-gray-700 uppercase tracking-wider">Time</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody"></tbody>
            </table>
        </div>
        
    </div>

    <script>
        const SUPABASE_URL = "https://ipakwgzbbjywzccoahiw.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwYWt3Z3piYmp5d3pjY29haGl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxOTAyMjQsImV4cCI6MjA3Nzc2NjIyNH0.VNjAhpbMzv9c19-IAg8UF2u28aIhh5OYCjAhcec9dRk";
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        Chart.register(ChartDataLabels);
        let myChart = null; 
        let globalReports = []; 

        // --- PDF GENERATOR ---
        function downloadPDF() {
            if(document.getElementById('resultsArea').classList.contains('hidden')) {
                alert("Please select a student and click 'Show Report' first.");
                return;
            }

            const element = document.getElementById('printableArea');
            const studentName = document.getElementById('studentDropdown').value || "Student";
            const header = document.getElementById('pdfHeader');
            const monthPicker = document.getElementById('monthPicker');
            const monthLabel = document.getElementById('pdfMonthLabel');
            
            // Setup PDF Mode
            header.classList.remove('hidden');
            document.getElementById('pdfGenDate').innerText = new Date().toLocaleDateString('en-IN');
            document.getElementById('pdfStudentName').innerText = studentName;
            
            monthPicker.classList.add('hidden');
            monthLabel.innerText = monthPicker.value; 
            monthLabel.classList.remove('hidden');

            element.classList.add('pdf-mode'); 
            
            const row = document.querySelector('.pdf-row-container .flex');
            row.classList.add('pdf-row');
            document.getElementById('calendarArea').classList.add('pdf-col-calendar');
            document.getElementById('graphArea').classList.add('pdf-col-graph');

            if(myChart) myChart.resize();

            // A4 Landscape Config
            const opt = {
                margin:       0.4, 
                filename:     `${studentName}_Report.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true }, 
                jsPDF:        { unit: 'in', format: 'a4', orientation: 'landscape' },
                pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] } 
            };

            // Generate
            html2pdf().set(opt).from(element).save().then(() => {
                // Restore Web View
                header.classList.add('hidden');
                element.classList.remove('pdf-mode');
                monthPicker.classList.remove('hidden');
                monthLabel.classList.add('hidden');
                row.classList.remove('pdf-row');
                document.getElementById('calendarArea').classList.remove('pdf-col-calendar');
                document.getElementById('graphArea').classList.remove('pdf-col-graph');
                
                if(myChart) myChart.resize(); 
            });
        }

        // --- HELPERS ---
        function getRawDate(isoString) {
            if (!isoString) return "-";
            const cleanDate = isoString.split('T')[0].split(' ')[0]; 
            const [year, month, day] = cleanDate.split('-');
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            return `${day} ${months[parseInt(month)-1]} ${year}`;
        }

        function formatTimeTaken(input) {
            if (!input) return "-";
            if (typeof input === 'string' && input.includes(':')) return input + " m";
            const s = parseInt(input);
            if (isNaN(s)) return input;
            const mins = Math.floor(s / 60);
            const secs = s % 60;
            if (mins > 0) return `${mins}m ${secs}s`;
            return `${secs}s`;
        }

        // --- STARTUP ---
        document.addEventListener('DOMContentLoaded', async () => {
            const dropdown = document.getElementById('studentDropdown');
            dropdown.innerHTML = '<option>Loading...</option>';
            
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                dropdown.innerHTML = '<option>Error: No Session</option>';
                alert("You are not logged in!");
                return;
            }

            const { data, error } = await supabase.from('reports').select('student_name');
            if (error) { dropdown.innerHTML = '<option>Error</option>'; return; }
            if (!data || data.length === 0) { dropdown.innerHTML = '<option>No students</option>'; return; }

            const uniqueNames = [...new Set(data.map(item => item.student_name))];
            dropdown.innerHTML = '<option value="">-- Choose a Student --</option>';
            uniqueNames.sort().forEach(name => {
                if(name) { 
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    dropdown.appendChild(option);
                }
            });
            
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('monthPicker').value = `${yyyy}-${mm}`;
        });

        // --- FETCH DATA ---
        async function getReport() {
            const studentName = document.getElementById('studentDropdown').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if(!studentName) { alert("Please select a student first!"); return; }

            if(startDate && endDate) {
                document.getElementById('pdfDateRange').innerText = `${startDate} to ${endDate}`;
            } else {
                document.getElementById('pdfDateRange').innerText = "All Time";
            }

            document.getElementById('resultsArea').classList.add('hidden');
            document.getElementById('tableContainer').classList.add('hidden');
            document.getElementById('calendarArea').classList.add('hidden');
            document.getElementById('graphArea').classList.add('hidden');
            
            const { data: reports, error } = await supabase
                .from('reports')
                .select('*')
                .eq('student_name', studentName)
                .order('indian_time', { ascending: false });

            if(error) { alert("Error: " + error.message); return; }
            
            if(reports) {
                globalReports = reports;
                const filteredReports = filterByDate(reports, startDate, endDate);
                
                renderTable(filteredReports);
                renderGraph(filteredReports); 
                renderCalendar(globalReports); 
            }
        }

        function filterByDate(reports, start, end) {
            if (!start && !end) return reports;
            return reports.filter(r => {
                if (!r.indian_time) return false;
                const rowDate = r.indian_time.split('T')[0].split(' ')[0];
                let valid = true;
                if (start && rowDate < start) valid = false;
                if (end && rowDate > end) valid = false;
                return valid;
            });
        }

        function updateCalendarOnly() {
            if (globalReports.length > 0) renderCalendar(globalReports);
        }

        // --- RENDER GRAPH ---
        function renderGraph(reports) {
            document.getElementById('graphArea').classList.remove('hidden');
            
            let counts = { plusMinus: 0, multi: 0, division: 0 };
            reports.forEach(r => {
                const type = (r.challenge_type || "").toLowerCase();
                if (type.includes('div') || type.includes('by') || type.includes('/')) counts.division++;
                else if (type.includes('x') || type.includes('marathon') || type.includes('multi')) counts.multi++;
                else counts.plusMinus++;
            });

            const maxVal = Math.max(counts.plusMinus, counts.multi, counts.division);
            if (myChart) myChart.destroy();

            const ctx = document.getElementById('practiceChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Plus & Minus', 'Multiplication', 'Division'],
                    datasets: [{
                        label: 'Practices',
                        data: [counts.plusMinus, counts.multi, counts.division],
                        backgroundColor: ['#f59e0b', '#3b82f6', '#8b5cf6'], 
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { display: true, color: '#f3f4f6' }, suggestedMax: maxVal + 5 },
                        x: { grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            color: '#333', anchor: 'end', align: 'top', offset: 0,
                            font: { weight: 'bold', size: 12 },
                            formatter: function(value) { return value > 0 ? value : ''; }
                        }
                    }
                }
            });
        }

        // --- RENDER TABLE ---
        function renderTable(reports) {
            document.getElementById('resultsArea').classList.remove('hidden');
            document.getElementById('tableContainer').classList.remove('hidden');
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = '';
            let count = 0;
            
            if (reports.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="px-5 py-6 text-center text-gray-400 font-bold">No records found.</td></tr>`;
                document.getElementById('totalCount').innerText = "0";
                return;
            }

            let htmlContent = '';
            reports.forEach(row => {
                const dateStr = getRawDate(row.indian_time);
                count++;
                const timeTaken = row.time_taken || row.duration || row.timer || 0;
                const tr = `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-5 py-4 text-sm font-bold text-gray-800">${dateStr}</td>
                        <td class="px-5 py-4 text-sm font-medium text-gray-600 capitalize">${row.challenge_type || 'Practice'}</td>
                        <td class="px-5 py-4 text-sm font-bold text-indigo-600">${row.score_text || row.score}</td>
                        <td class="px-5 py-4 text-sm font-bold text-gray-700">‚è±Ô∏è ${formatTimeTaken(timeTaken)}</td>
                    </tr>`;
                htmlContent += tr;
            });
            tbody.innerHTML = htmlContent;
            document.getElementById('totalCount').innerText = count;
            document.getElementById('lastActive').innerText = globalReports.length > 0 ? getRawDate(globalReports[0].indian_time) : 'N/A';
        }

        // --- RENDER CALENDAR ---
        function renderCalendar(reports) {
            const calendarArea = document.getElementById('calendarArea');
            const grid = document.getElementById('calendarGrid');
            const monthInput = document.getElementById('monthPicker').value;
            calendarArea.classList.remove('hidden');
            grid.innerHTML = '';

            let date = new Date();
            if (monthInput) {
                const [y, m] = monthInput.split('-');
                date = new Date(y, m - 1, 1);
            }
            const year = date.getFullYear();
            const month = date.getMonth(); 

            const practiceDates = new Set();
            reports.forEach(r => {
                if(!r.indian_time) return;
                const cleanDate = r.indian_time.split('T')[0].split(' ')[0];
                const [rYear, rMonth, rDay] = cleanDate.split('-').map(Number);
                if ((rMonth - 1) === month && rYear === year) practiceDates.add(cleanDate);
            });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += `<div class="h-10 bg-gray-50 rounded"></div>`;
            }

            const now = new Date();
            const todayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;

            for (let day = 1; day <= daysInMonth; day++) {
                const currentMonth = (month + 1).toString().padStart(2, '0');
                const currentDay = day.toString().padStart(2, '0');
                const checkDate = `${year}-${currentMonth}-${currentDay}`;
                const isPracticed = practiceDates.has(checkDate);
                
                let colorClass = "bg-white border-gray-100 text-gray-300"; 
                if (isPracticed) colorClass = "bg-green-100 border-green-300 text-green-700 shadow-sm";
                else if (checkDate < todayStr && checkDate >= `${year}-${currentMonth}-01`) colorClass = "bg-red-50 border-red-100 text-red-400";

                grid.innerHTML += `<div class="h-10 border rounded flex items-center justify-center font-bold text-xs ${colorClass}">${day}${isPracticed ? '<span class="ml-1">‚úì</span>' : ''}</div>`;
            }
        }
    </script>
</body>
</html>
