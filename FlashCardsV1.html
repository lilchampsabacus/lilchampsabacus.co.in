<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Li'l Champs Abacus Academy Ambernath</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&display=swap');

        /* Responsive Variables */
        :root {
            --bead-w: 50px;
            --bead-h: 30px;
            --col-w: 60px;
            --rod-h: 240px;
            --heaven-h: 60px;
            --earth-h: 150px;
            --beam-top: 60px;
            --bead-radius: 5px;
        }

        /* Mobile Breakpoint (Small screens) */
        @media (max-width: 640px) {
            :root {
                --bead-w: 34px;
                --bead-h: 22px;
                --col-w: 40px;
                --rod-h: 180px;
                --heaven-h: 45px;
                --earth-h: 110px;
                --beam-top: 45px;
                --bead-radius: 3px;
            }
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #f0f9ff;
            overflow-x: hidden;
            min-h-screen: 100dvh; /* Dynamic viewport height for mobile */
        }

        /* Abacus Bead Styling */
        .bead-shape {
            width: var(--bead-w);
            height: var(--bead-h);
            background: linear-gradient(145deg, #4a2c2c, #2d1b1b);
            border-radius: var(--bead-radius);
            clip-path: polygon(15% 0%, 85% 0%, 100% 50%, 85% 100%, 15% 100%, 0% 50%);
            margin: 0;
            transition: top 0.3s ease-in-out; 
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }
        
        .bead-shape::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20%;
            height: 30%;
            background: rgba(255,255,255,0.15);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        /* Rod and Beam Styling */
        .abacus-rod {
            width: 4px;
            background-color: #555;
            height: var(--rod-h);
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            z-index: 0;
        }

        .abacus-beam {
            height: 10px;
            background-color: #333;
            width: 100%;
            position: absolute;
            top: var(--beam-top); 
            z-index: 20;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border-top: 1px solid #666;
            border-bottom: 1px solid #666;
        }

        /* Layout Helpers */
        .column-container {
            position: relative;
            width: var(--col-w);
            height: calc(var(--rod-h) + 10px);
            display: inline-block;
            margin: 0 1px;
        }

        .heaven-deck {
            position: absolute;
            top: 0;
            width: 100%;
            height: var(--heaven-h);
        }

        .earth-deck {
            position: absolute;
            top: calc(var(--beam-top) + 10px); /* Beam height is roughly 10px */
            width: 100%;
            height: var(--earth-h);
        }

        /* Animations */
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        .card-enter { animation: popIn 0.4s ease-out forwards; }
        .floating-title { animation: float 3s ease-in-out infinite; }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            animation: fall linear forwards;
            z-index: 100;
        }

        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); }
        }

        /* Utility for hiding scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-blue-50 text-gray-800 min-h-[100dvh] flex flex-col items-center overflow-y-auto overflow-x-hidden">

    <!-- HEADER -->
    <header class="w-full p-3 md:p-4 flex justify-between items-center bg-white shadow-sm z-50 sticky top-0">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-calculator text-yellow-500 text-xl md:text-2xl"></i>
            <h1 class="text-lg md:text-2xl font-bold text-pink-600 tracking-wide truncate max-w-[200px] md:max-w-none">Li'l Champs Abacus Academy Ambernath</h1>
        </div>
        <div id="header-stats" class="hidden flex gap-3 md:gap-6 font-semibold text-sm md:text-lg">
            <span class="text-blue-600 bg-blue-50 px-2 py-1 rounded-lg"><i class="fa-solid fa-hashtag mr-1"></i> <span id="card-counter">1/20</span></span>
            <span class="text-green-600 bg-green-50 px-2 py-1 rounded-lg"><i class="fa-solid fa-star mr-1"></i> <span id="score-display">0</span></span>
        </div>
        <button onclick="location.reload()" class="text-gray-400 hover:text-gray-600 text-sm md:text-base"><i class="fa-solid fa-rotate-right"></i> <span class="hidden sm:inline">Restart</span></button>
    </header>

    <!-- MAIN CONTENT AREA -->
    <main id="app" class="flex-1 w-full max-w-4xl p-2 md:p-4 flex flex-col justify-start md:justify-center items-center relative">
        
        <!-- SCREEN: SETUP -->
        <div id="setup-screen" class="bg-white p-6 md:p-8 rounded-3xl shadow-xl w-full max-w-lg text-center border-b-8 border-yellow-400 card-enter mt-4 md:mt-0">
            <h2 class="text-3xl md:text-4xl font-bold text-gray-700 mb-2 floating-title">Let's Practice!</h2>
            <p class="text-gray-500 mb-6">Configure your flash cards</p>

            <!-- Digits Selection -->
            <div class="mb-4 md:mb-6">
                <label class="block text-left font-bold text-gray-600 mb-2 ml-1 text-sm md:text-base">How many digits?</label>
                <div class="flex justify-between gap-1 md:gap-2">
                    <button onclick="selectDigits(1)" class="digit-btn flex-1 py-2 md:py-3 rounded-xl bg-gray-100 hover:bg-pink-100 border-2 border-transparent hover:border-pink-400 font-bold text-lg md:text-xl transition-all" data-val="1">1</button>
                    <button onclick="selectDigits(2)" class="digit-btn flex-1 py-2 md:py-3 rounded-xl bg-gray-100 hover:bg-pink-100 border-2 border-transparent hover:border-pink-400 font-bold text-lg md:text-xl transition-all" data-val="2">2</button>
                    <button onclick="selectDigits(3)" class="digit-btn flex-1 py-2 md:py-3 rounded-xl bg-blue-100 border-2 border-blue-500 text-blue-700 font-bold text-lg md:text-xl transition-all shadow-md" data-val="3">3</button>
                    <button onclick="selectDigits(4)" class="digit-btn flex-1 py-2 md:py-3 rounded-xl bg-gray-100 hover:bg-pink-100 border-2 border-transparent hover:border-pink-400 font-bold text-lg md:text-xl transition-all" data-val="4">4</button>
                    <button onclick="selectDigits(5)" class="digit-btn flex-1 py-2 md:py-3 rounded-xl bg-gray-100 hover:bg-pink-100 border-2 border-transparent hover:border-pink-400 font-bold text-lg md:text-xl transition-all" data-val="5">5</button>
                </div>
            </div>

            <!-- Speed Selection -->
            <div class="mb-4 md:mb-6">
                <label class="block text-left font-bold text-gray-600 mb-2 ml-1 text-sm md:text-base">Speed</label>
                <div class="grid grid-cols-3 gap-2 md:gap-3">
                    <button onclick="selectSpeed('slow')" class="speed-btn py-2 md:py-3 rounded-xl bg-green-100 border-2 border-green-500 text-green-700 font-bold transition-all shadow-md text-sm md:text-base" data-val="slow">
                        <i class="fa-solid fa-bicycle mb-1 block text-xl md:text-2xl"></i> Slow
                    </button>
                    <button onclick="selectSpeed('fast')" class="speed-btn py-2 md:py-3 rounded-xl bg-gray-100 hover:bg-yellow-100 border-2 border-transparent hover:border-yellow-400 text-gray-600 font-bold transition-all text-sm md:text-base" data-val="fast">
                        <i class="fa-solid fa-car mb-1 block text-xl md:text-2xl"></i> Fast
                    </button>
                    <button onclick="selectSpeed('fastest')" class="speed-btn py-2 md:py-3 rounded-xl bg-gray-100 hover:bg-red-100 border-2 border-transparent hover:border-red-400 text-gray-600 font-bold transition-all text-sm md:text-base" data-val="fastest">
                        <i class="fa-solid fa-rocket mb-1 block text-xl md:text-2xl"></i> Turbo
                    </button>
                </div>
            </div>

             <!-- Mode Selection -->
             <div class="mb-6 md:mb-8">
                <label class="block text-left font-bold text-gray-600 mb-2 ml-1 text-sm md:text-base">Mode</label>
                <div class="flex gap-2 md:gap-3">
                    <button onclick="selectMode('practice')" class="mode-btn flex-1 py-2 md:py-3 rounded-xl bg-gray-100 hover:bg-purple-100 border-2 border-transparent hover:border-purple-400 font-bold transition-all text-sm md:text-base" data-val="practice">
                        <i class="fa-solid fa-eye mr-1 md:mr-2"></i>Learn
                    </button>
                    <button onclick="selectMode('quiz')" class="mode-btn flex-1 py-2 md:py-3 rounded-xl bg-purple-100 border-2 border-purple-500 text-purple-700 font-bold transition-all shadow-md text-sm md:text-base" data-val="quiz">
                        <i class="fa-solid fa-keyboard mr-1 md:mr-2"></i>Quiz
                    </button>
                </div>
                <p id="mode-desc" class="text-xs md:text-sm text-gray-500 mt-2">The beads flash, you type the number!</p>
            </div>

            <button onclick="startGame()" class="w-full py-3 md:py-4 rounded-full bg-pink-500 hover:bg-pink-600 text-white font-bold text-xl md:text-2xl shadow-lg transform hover:scale-105 active:scale-95 transition-all">
                Start Playing <i class="fa-solid fa-play ml-2"></i>
            </button>
        </div>

        <!-- SCREEN: GAME -->
        <div id="game-screen" class="hidden w-full flex flex-col items-center mt-2 md:mt-0">
            
            <!-- Progress Bar -->
            <div class="w-full max-w-2xl bg-gray-200 rounded-full h-2 mb-4 md:mb-6">
                <div id="timer-bar" class="bg-pink-500 h-2 rounded-full transition-all duration-75" style="width: 100%"></div>
            </div>

            <!-- The Card -->
            <div id="flash-card" class="relative bg-white p-1 rounded-2xl shadow-xl flex flex-col md:flex-row w-full max-w-3xl overflow-hidden border-4 border-yellow-400 card-enter min-h-[300px] md:min-h-[350px]">
                
                <!-- Number Side -->
                <div id="number-panel" class="h-32 md:h-auto md:w-1/3 bg-yellow-400 flex items-center justify-center p-4 relative transition-all duration-300 border-b-2 md:border-b-0 md:border-r-2 border-yellow-500/30">
                    <!-- Removed hardcoded size classes -->
                    <div id="number-display" class="font-serif font-bold text-gray-900 opacity-0 transform scale-50 transition-all duration-500">
                        ?
                    </div>
                    <div class="absolute top-2 left-2 text-yellow-800 opacity-50 font-bold text-xs md:text-sm tracking-widest">NUMBER</div>
                </div>

                <!-- Abacus Side -->
                <div class="flex-1 bg-pink-500 flex items-center justify-center p-2 md:p-4 relative min-h-[200px]">
                    <div class="absolute top-2 left-2 text-pink-200 opacity-60 font-bold text-xs md:text-sm tracking-widest">ABACUS</div>
                    
                    <!-- Abacus Container -->
                    <div id="abacus-stage" class="bg-pink-600/20 rounded-xl p-2 md:p-4 shadow-inner flex items-center justify-center gap-0 md:gap-2 border border-pink-400/50 backdrop-blur-sm">
                        <!-- Columns injected by JS -->
                    </div>
                </div>

                <!-- Feedback Overlay -->
                <div id="feedback-overlay" class="absolute inset-0 pointer-events-none flex items-center justify-center z-50 opacity-0 transition-opacity duration-300 bg-white/80 backdrop-blur-sm">
                    <i class="fa-solid fa-check-circle text-green-500 text-8xl md:text-9xl drop-shadow-lg hidden scale-in" id="icon-correct"></i>
                    <i class="fa-solid fa-xmark-circle text-red-500 text-8xl md:text-9xl drop-shadow-lg hidden scale-in" id="icon-wrong"></i>
                </div>
            </div>

            <!-- Input Area (For Quiz Mode) -->
            <div id="input-area" class="mt-4 md:mt-8 w-full max-w-sm flex gap-2 hidden opacity-0 transition-opacity duration-300">
                <input type="tel" inputmode="numeric" pattern="[0-9]*" id="user-input" class="flex-1 p-3 md:p-4 text-2xl md:text-3xl text-center font-bold rounded-xl border-4 border-blue-300 focus:border-blue-500 outline-none shadow-lg" placeholder="?" autocomplete="off">
                <button onclick="checkAnswer()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 md:px-8 rounded-xl font-bold text-xl shadow-lg active:scale-95 transition-transform">
                    GO
                </button>
            </div>

            <!-- Control Area (For Practice Mode) -->
            <div id="practice-controls" class="mt-6 hidden">
                <div class="px-6 py-2 bg-white rounded-full shadow-sm text-lg font-bold text-gray-500 animate-pulse flex items-center gap-2">
                    <i class="fa-solid fa-forward text-pink-400"></i> Auto-playing...
                </div>
            </div>

        </div>

        <!-- SCREEN: RESULTS -->
        <div id="result-screen" class="hidden bg-white p-6 md:p-8 rounded-3xl shadow-xl w-full max-w-lg text-center border-b-8 border-green-400 card-enter mt-4">
            <i class="fa-solid fa-trophy text-5xl md:text-6xl text-yellow-400 mb-4 floating-title"></i>
            <h2 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">Great Job!</h2>
            <p class="text-gray-500 mb-6">Session Complete</p>
            
            <div class="bg-blue-50 rounded-xl p-6 mb-8">
                <div class="text-xs md:text-sm text-gray-500 uppercase tracking-wide font-bold">Final Score</div>
                <div class="text-5xl md:text-6xl font-bold text-blue-600 my-2"><span id="final-score">0</span><span class="text-2xl md:text-3xl text-gray-400">/20</span></div>
                <div id="feedback-text" class="text-base md:text-lg font-semibold text-blue-400">Master of the beads!</div>
            </div>

            <button onclick="location.reload()" class="w-full py-3 md:py-4 rounded-full bg-green-500 hover:bg-green-600 text-white font-bold text-xl shadow-lg transform hover:scale-105 transition-all">
                Practice Again
            </button>
        </div>

    </main>

    <!-- FOOTER -->
    <footer class="w-full p-4 flex justify-center mt-auto z-10">
        <a href="practice_options.html" class="px-6 py-3 rounded-full bg-white/80 hover:bg-white border-2 border-pink-200 text-pink-500 hover:text-pink-700 font-bold flex items-center gap-2 transition-all shadow-sm hover:shadow-md">
            <i class="fa-solid fa-arrow-left"></i> Back to Options
        </a>
    </footer>
    
    <!-- SCRIPTS -->
    <script>
        // --- Game State ---
        const state = {
            digits: 3,
            speed: 'slow',
            mode: 'quiz',
            currentCard: 0,
            totalCards: 20,
            score: 0,
            currentNumber: 0,
            timerInterval: null,
            isInputLocked: false
        };

        const speeds = {
            slow: 5000,
            fast: 3000,
            fastest: 1500
        };

        // --- Screen Size Handling ---
        let dimensions = {
            beadH: 30,
            heavenH: 60,
            gap: 45
        };

        function updateDimensions() {
            // Matches CSS breakpoints
            if (window.innerWidth < 640) {
                dimensions = { beadH: 22, heavenH: 45, gap: 35 };
            } else {
                dimensions = { beadH: 30, heavenH: 60, gap: 45 };
            }
            // Re-render if game is active
            if(!document.getElementById('game-screen').classList.contains('hidden')) {
                renderAbacus(state.currentNumber);
            }
        }
        window.addEventListener('resize', updateDimensions);
        updateDimensions(); // Initial call

        // --- Setup Functions ---
        function selectDigits(n) {
            state.digits = n;
            document.querySelectorAll('.digit-btn').forEach(btn => {
                const val = parseInt(btn.dataset.val);
                if(val === n) {
                    btn.className = "digit-btn flex-1 py-2 md:py-3 rounded-xl bg-blue-100 border-2 border-blue-500 text-blue-700 font-bold text-lg md:text-xl transition-all shadow-md";
                } else {
                    btn.className = "digit-btn flex-1 py-2 md:py-3 rounded-xl bg-gray-100 hover:bg-pink-100 border-2 border-transparent hover:border-pink-400 font-bold text-lg md:text-xl transition-all";
                }
            });
        }

        function selectSpeed(s) {
            state.speed = s;
            document.querySelectorAll('.speed-btn').forEach(btn => {
                const isSelected = btn.dataset.val === s;
                // Reset
                btn.classList.remove('bg-green-100', 'border-green-500', 'text-green-700', 
                                   'bg-yellow-100', 'border-yellow-500', 'text-yellow-700',
                                   'bg-red-100', 'border-red-500', 'text-red-700', 'border-2', 'shadow-md');
                btn.classList.add('bg-gray-100', 'text-gray-600', 'border-transparent');

                if (isSelected) {
                    btn.classList.remove('bg-gray-100', 'text-gray-600', 'border-transparent');
                    btn.classList.add('border-2', 'shadow-md');
                    if(s === 'slow') btn.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
                    if(s === 'fast') btn.classList.add('bg-yellow-100', 'border-yellow-500', 'text-yellow-700');
                    if(s === 'fastest') btn.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
                } else {
                    // Hover states
                    if(btn.dataset.val === 'slow') btn.classList.add('hover:bg-green-50', 'hover:border-green-300');
                    if(btn.dataset.val === 'fast') btn.classList.add('hover:bg-yellow-50', 'hover:border-yellow-300');
                    if(btn.dataset.val === 'fastest') btn.classList.add('hover:bg-red-50', 'hover:border-red-300');
                    btn.classList.add('border-2'); // Placeholder for border
                }
            });
        }

        function selectMode(m) {
            state.mode = m;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                if(btn.dataset.val === m) {
                    btn.className = "mode-btn flex-1 py-2 md:py-3 rounded-xl bg-purple-100 border-2 border-purple-500 text-purple-700 font-bold transition-all shadow-md text-sm md:text-base";
                } else {
                    btn.className = "mode-btn flex-1 py-2 md:py-3 rounded-xl bg-gray-100 hover:bg-purple-100 border-2 border-transparent hover:border-purple-400 font-bold transition-all text-sm md:text-base";
                }
            });
            const desc = document.getElementById('mode-desc');
            desc.textContent = m === 'quiz' 
                ? "The beads flash, you type the number!" 
                : "Relax and watch the numbers and beads together.";
        }

        function startGame() {
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('header-stats').classList.remove('hidden');
            document.getElementById('header-stats').classList.add('flex');
            
            if(state.mode === 'quiz') {
                document.getElementById('input-area').classList.remove('hidden');
                setTimeout(() => document.getElementById('input-area').classList.remove('opacity-0'), 50);
            } else {
                document.getElementById('practice-controls').classList.remove('hidden');
            }

            state.currentCard = 0;
            state.score = 0;
            nextCard();
        }

        function generateNumber() {
            const min = Math.pow(10, state.digits - 1);
            const max = Math.pow(10, state.digits) - 1;
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function renderAbacus(num) {
            const container = document.getElementById('abacus-stage');
            container.innerHTML = '';
            const strNum = num.toString();
            
            // Use responsive dimensions
            const BEAD_H = dimensions.beadH;
            const HEAVEN_H = dimensions.heavenH;
            const GAP = dimensions.gap;

            for(let i=0; i<strNum.length; i++) {
                const digit = parseInt(strNum[i]);
                const topActive = digit >= 5;
                const remainder = digit % 5;

                const col = document.createElement('div');
                col.className = 'column-container';
                
                const rod = document.createElement('div');
                rod.className = 'abacus-rod';
                col.appendChild(rod);

                // HEAVEN
                const heaven = document.createElement('div');
                heaven.className = 'heaven-deck';
                
                const topBead = document.createElement('div');
                topBead.className = `bead-shape`;
                // Active = Down (touching beam)
                topBead.style.top = topActive ? `${HEAVEN_H - BEAD_H}px` : '0px';
                
                heaven.appendChild(topBead);
                col.appendChild(heaven);

                // BEAM
                const beam = document.createElement('div');
                beam.className = 'abacus-beam';
                col.appendChild(beam);

                // EARTH
                const earth = document.createElement('div');
                earth.className = 'earth-deck';
                
                for(let b=0; b<4; b++) {
                    const bead = document.createElement('div');
                    bead.className = 'bead-shape';
                    let topPos;

                    if (b < remainder) {
                        // Active (UP), touching beam/stack
                        topPos = b * BEAD_H; 
                    } else {
                        // Inactive (DOWN), stacking from gap
                        topPos = (b * BEAD_H) + GAP;
                    }
                    
                    bead.style.top = `${topPos}px`;
                    earth.appendChild(bead);
                }
                col.appendChild(earth);
                container.appendChild(col);
            }
        }

        function nextCard() {
            if(state.currentCard >= state.totalCards) {
                endGame();
                return;
            }

            state.currentCard++;
            document.getElementById('card-counter').innerText = `${state.currentCard}/${state.totalCards}`;
            
            state.currentNumber = generateNumber();
            state.isInputLocked = false;

            const numDisplay = document.getElementById('number-display');
            const userInput = document.getElementById('user-input');
            const numPanel = document.getElementById('number-panel');
            
            userInput.value = '';
            document.getElementById('feedback-overlay').style.opacity = '0';
            document.getElementById('icon-correct').classList.add('hidden');
            document.getElementById('icon-wrong').classList.add('hidden');

            // Dynamic Font Sizing logic
            // Reset base classes first
            numDisplay.className = "font-serif font-bold text-gray-900 opacity-0 transform scale-50 transition-all duration-500";
            
            // Apply specific size
            if (state.digits === 5) {
                 numDisplay.classList.add('text-5xl', 'md:text-6xl'); // Smaller for 5 digits
            } else if (state.digits === 4) {
                 numDisplay.classList.add('text-6xl', 'md:text-7xl');
            } else {
                 numDisplay.classList.add('text-6xl', 'md:text-8xl'); // Original size for 1-3 digits
            }

            renderAbacus(state.currentNumber);

            if(state.mode === 'practice') {
                numDisplay.innerText = state.currentNumber;
                numDisplay.style.opacity = '1';
                numDisplay.style.transform = 'scale(1)';
                numPanel.classList.remove('bg-yellow-400');
                numPanel.classList.add('bg-white'); 
                startTimer(nextCard);
            } else {
                // Quiz Mode
                numDisplay.innerText = "?";
                numDisplay.style.opacity = '0.3';
                numDisplay.style.transform = 'scale(0.5)';
                numPanel.classList.add('bg-yellow-400');
                numPanel.classList.remove('bg-white');

                userInput.focus(); 
                
                startTimer(() => {
                    document.getElementById('abacus-stage').style.transition = 'opacity 0.2s';
                    document.getElementById('abacus-stage').style.opacity = '0';
                });
            }
        }

        function startTimer(callback) {
            const bar = document.getElementById('timer-bar');
            const duration = speeds[state.speed];
            let start = Date.now();
            
            document.getElementById('abacus-stage').style.opacity = '1';

            if(state.timerInterval) clearInterval(state.timerInterval);

            state.timerInterval = setInterval(() => {
                let timePassed = Date.now() - start;
                let pct = 100 - (timePassed / duration * 100);
                
                if(pct <= 0) {
                    pct = 0;
                    clearInterval(state.timerInterval);
                    callback();
                }
                bar.style.width = pct + "%";
            }, 50);
        }

        function checkAnswer() {
            if(state.isInputLocked) return;
            
            const input = document.getElementById('user-input');
            if(input.value === '') return;
            
            const val = parseInt(input.value);
            if(isNaN(val)) return;

            state.isInputLocked = true;
            clearInterval(state.timerInterval);

            const isCorrect = val === state.currentNumber;
            
            const overlay = document.getElementById('feedback-overlay');
            overlay.style.opacity = '1';
            
            if(isCorrect) {
                document.getElementById('icon-correct').classList.remove('hidden');
                state.score++;
                document.getElementById('score-display').innerText = state.score;
                createConfetti();
            } else {
                document.getElementById('icon-wrong').classList.remove('hidden');
                const numDisplay = document.getElementById('number-display');
                numDisplay.innerText = state.currentNumber;
                numDisplay.style.opacity = '1';
                numDisplay.style.transform = 'scale(1)';
                numDisplay.style.color = '#dc2626'; // red-600
                // Reset color after a moment
                setTimeout(() => numDisplay.style.color = '', 1500);
            }

            setTimeout(() => {
                nextCard();
            }, 1500);
        }

        document.getElementById('user-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });

        function endGame() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = state.score;
            
            const msg = document.getElementById('feedback-text');
            const pct = state.score / state.totalCards;
            if(pct === 1) msg.innerText = "Perfect Score! You are a Soroban Master! üèÜ";
            else if(pct > 0.8) msg.innerText = "Amazing work! Almost perfect! üåü";
            else if(pct > 0.5) msg.innerText = "Good practice! Keep going! üëç";
            else msg.innerText = "Keep practicing, you'll get it! üí™";
        }

        function createConfetti() {
            for(let i=0; i<30; i++) {
                const conf = document.createElement('div');
                conf.classList.add('confetti');
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.backgroundColor = ['#ff0', '#f0f', '#0ff', '#0f0'][Math.floor(Math.random()*4)];
                conf.style.animationDuration = Math.random() * 2 + 1 + 's';
                document.body.appendChild(conf);
                setTimeout(() => conf.remove(), 3000);
            }
        }
    </script>
</body>
</html>

