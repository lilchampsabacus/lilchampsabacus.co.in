<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Flash Cards - Li'l Champs Abacus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- THEME FROM 3by1.html --- */
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0f9ff; 
            background-image: radial-gradient(#e0f2fe 2px, transparent 2px);
            background-size: 24px 24px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- ABACUS VISUALS --- */
        :root {
            --bead-w: 60px;
            --bead-h: 36px;
            --col-w: 70px;
            --rod-h: 280px;
            --heaven-h: 70px;
            --earth-h: 180px;
            --beam-top: 70px;
            --bead-radius: 5px;
        }

        /* Abacus Components */
        .bead-shape {
            width: var(--bead-w);
            height: var(--bead-h);
            background: linear-gradient(145deg, #2d1b1b, #000000); 
            border-radius: var(--bead-radius);
            clip-path: polygon(15% 0%, 85% 0%, 100% 50%, 85% 100%, 15% 100%, 0% 50%);
            margin: 0;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .bead-shape::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20%;
            height: 30%;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        .abacus-rod {
            width: 6px;
            background-color: #cbd5e1;
            height: var(--rod-h);
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            z-index: 0;
        }

        .abacus-beam {
            height: 14px;
            background-color: #334155;
            width: 100%;
            position: absolute;
            top: var(--beam-top); 
            z-index: 20;
            border-radius: 2px;
            border-top: 2px solid #94a3b8;
            border-bottom: 2px solid #0f172a;
        }

        .column-container {
            position: relative;
            width: var(--col-w);
            height: calc(var(--rod-h) + 10px);
            display: inline-block;
            margin: 0 2px;
        }

        .heaven-deck { position: absolute; top: 0; width: 100%; height: var(--heaven-h); }
        .earth-deck { position: absolute; top: calc(var(--beam-top) + 14px); width: 100%; height: var(--earth-h); }

        /* Animations */
        .fade-enter { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col font-sans">

    <button id="floating-stop-btn" onclick="stopSequence()" class="hidden fixed top-4 right-4 z-[60] bg-red-600 text-white rounded-full p-4 shadow-lg hover:bg-red-700 transition-all transform hover:scale-110 border-2 border-white">
        <i class="fa-solid fa-xmark text-xl"></i>
    </button>

    <header class="bg-indigo-600 text-black p-4 shadow-lg sticky top-0 z-50 flex justify-between items-center">
        <div class="max-w-7xl flex items-center gap-4">
            <h1 class="text-xl sm:text-2xl font-bold text-white">Li'l Champs Abacus Academy, Ambernath</h1>
            <span class="bg-white/20 text-white px-3 py-1 rounded-full text-sm font-bold backdrop-blur-sm border border-white/30">Flash Cards</span>
        </div>
        
        <div class="flex gap-2">
            <button onclick="toggleHistory()" id="btn-history" class="hidden px-4 py-2 bg-indigo-500 text-white rounded-lg font-bold hover:bg-indigo-400 transition-colors text-sm border border-indigo-400">
                <i class="fa-solid fa-list-ol mr-2"></i> History
            </button>
            <button onclick="stopSequence()" id="btn-stop" class="hidden px-6 py-2 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 transition-colors shadow-md text-sm border border-red-400">
                <i class="fa-solid fa-stop mr-2"></i> Stop
            </button>
        </div>
    </header>

    <main class="flex-grow flex flex-col items-center justify-center p-4 overflow-y-auto w-full relative">

        <div id="setup-panel" class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-2xl border-4 border-indigo-100 fade-enter my-auto">
            <h2 class="text-2xl font-extrabold text-gray-800 mb-6 flex items-center gap-2 border-b border-gray-100 pb-3">
                <i class="fa-solid fa-sliders text-indigo-600"></i> Configuration
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-600 font-bold mb-1 text-sm uppercase tracking-wide">Number of Flash cards</label>
                        <input type="number" id="inp-count" value="20" min="1" max="100" class="w-full p-3 border-2 border-gray-200 rounded-xl font-bold text-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-colors">
                    </div>
                    
                    <div>
                        <label class="block text-gray-600 font-bold mb-1 text-sm uppercase tracking-wide">Speed</label>
                        <div class="flex gap-2">
                            <select id="inp-speed" class="flex-1 p-3 border-2 border-gray-200 rounded-xl font-bold text-base focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none bg-white">
                                <option value="slowest">Slowest</option>
                                <option value="slow">Slow</option>
                                <option value="normal" selected>Normal</option>
                                <option value="fast">Fast</option>
                                <option value="fastest">Fastest</option>
                            </select>
                            <button onclick="openSpeedModal()" class="px-4 bg-gray-100 text-gray-600 rounded-xl hover:bg-gray-200 transition-colors border-2 border-transparent hover:border-gray-300" title="Edit Speed Timings">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-gray-600 font-bold mb-2 text-sm uppercase tracking-wide">Group (Digits)</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="digits" value="1" class="peer sr-only">
                            <div class="p-2 border-2 border-gray-200 rounded-lg peer-checked:border-indigo-500 peer-checked:bg-indigo-50 font-bold text-gray-600 peer-checked:text-indigo-700 transition-all text-sm text-center shadow-sm">
                                1 Digit
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="digits" value="2" class="peer sr-only">
                            <div class="p-2 border-2 border-gray-200 rounded-lg peer-checked:border-indigo-500 peer-checked:bg-indigo-50 font-bold text-gray-600 peer-checked:text-indigo-700 transition-all text-sm text-center shadow-sm">
                                2 Digits
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="digits" value="3" checked class="peer sr-only">
                            <div class="p-2 border-2 border-gray-200 rounded-lg peer-checked:border-indigo-500 peer-checked:bg-indigo-50 font-bold text-gray-600 peer-checked:text-indigo-700 transition-all text-sm text-center shadow-sm">
                                3 Digits
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="digits" value="4" class="peer sr-only">
                            <div class="p-2 border-2 border-gray-200 rounded-lg peer-checked:border-indigo-500 peer-checked:bg-indigo-50 font-bold text-gray-600 peer-checked:text-indigo-700 transition-all text-sm text-center shadow-sm">
                                4 Digits
                            </div>
                        </label>
                        <label class="cursor-pointer col-span-2">
                            <input type="radio" name="digits" value="5" class="peer sr-only">
                            <div class="p-2 border-2 border-gray-200 rounded-lg peer-checked:border-indigo-500 peer-checked:bg-indigo-50 font-bold text-gray-600 peer-checked:text-indigo-700 transition-all text-sm text-center shadow-sm">
                                5 Digits
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <button onclick="startSequence()" class="w-full py-4 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold text-xl shadow-lg transform hover:scale-[1.02] active:scale-95 transition-all">
                ðŸš€ Launch Flash Cards
            </button>
        </div>

        <div id="display-panel" class="hidden w-full h-full flex flex-col items-center justify-center">
            
            <div id="flash-card-container" class="relative p-10 bg-white rounded-3xl shadow-2xl border-4 border-indigo-100 origin-center transition-transform duration-300 ease-out">
                <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white px-6 py-2 rounded-full border border-gray-200 shadow-sm font-bold text-xl text-indigo-800 z-20 whitespace-nowrap">
                    <span id="current-index">1</span> / <span id="total-count">10</span>
                </div>
                <div id="abacus-stage" class="flex items-center justify-center gap-2 min-h-[300px] transition-opacity duration-100"></div>
            </div>
            
        </div>

        <div id="history-panel" class="fixed inset-y-0 right-0 w-80 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-[100] flex flex-col border-l border-gray-200 pt-16 md:pt-0">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-indigo-50">
                <h3 class="font-bold text-lg text-indigo-800"><i class="fa-solid fa-clock-rotate-left mr-2"></i>Answer Key</h3>
                <button onclick="toggleHistory()" class="text-gray-500 hover:text-red-500 transition-colors">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <table class="w-full">
                    <thead>
                        <tr class="text-left text-xs font-bold text-gray-400 uppercase tracking-wider border-b">
                            <th class="pb-2 pl-2">#</th>
                            <th class="pb-2">Number</th>
                            <th class="pb-2 text-right">Time</th>
                        </tr>
                    </thead>
                    <tbody id="history-list" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
            <div class="p-4 border-t border-gray-100 bg-gray-50">
                <button onclick="downloadHistory()" class="w-full py-3 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg font-bold text-sm transition-colors shadow-sm">
                    <i class="fa-solid fa-download mr-1"></i> Save Report
                </button>
            </div>
        </div>

    </main>

    <footer class="bg-white text-center p-6 mt-auto border-t border-gray-200 z-40">
        <p class="text-sm text-gray-500">For any queries call <span class="font-bold text-indigo-600">9730482620</span></p>
    </footer>

    <div id="speed-modal" class="fixed inset-0 modal-backdrop hidden flex items-center justify-center z-[200] opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md transform scale-95 transition-transform duration-200 m-4 border-4 border-indigo-100" id="speed-modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800">Edit Speed Timings (ms)</h3>
                <button onclick="closeSpeedModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="space-y-3 mb-6">
                <div class="grid grid-cols-3 gap-2 text-xs font-bold text-gray-500 uppercase tracking-wide text-center">
                    <div class="text-left pl-2">Profile</div>
                    <div>Display</div>
                    <div>Interval</div>
                </div>
                <div id="speed-rows"></div>
            </div>
            <div class="flex gap-3">
                <button onclick="resetSpeeds()" class="flex-1 py-2 rounded-lg border border-gray-300 text-gray-600 font-bold hover:bg-gray-50 transition-colors">Default</button>
                <button onclick="saveSpeeds()" class="flex-1 py-2 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition-colors shadow-md">Save</button>
            </div>
        </div>
    </div>

    <script>
        // --- AUTHENTICATION CHECK ---
        // Checks if user is logged in, otherwise redirects to index.html
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
             window.location.href = 'index.html';
        }

        // --- CONFIGURATION ---
        const defaultSpeeds = {
            slowest: { display: 2500, interval: 1000 },
            slow:    { display: 1500, interval: 1000 },
            normal:  { display: 1000, interval: 500 },
            fast:    { display: 500,  interval: 500 },
            fastest: { display: 300,  interval: 200 }
        };

        let speeds = JSON.parse(localStorage.getItem('abacus_teacher_speeds')) || JSON.parse(JSON.stringify(defaultSpeeds));

        let appState = {
            sequence: [],
            currentIndex: 0,
            isPlaying: false,
            timer: null,
            config: { total: 10, digits: 3, speedKey: 'normal' }
        };

        const els = {
            setup: document.getElementById('setup-panel'),
            display: document.getElementById('display-panel'),
            history: document.getElementById('history-panel'),
            historyList: document.getElementById('history-list'),
            abacusStage: document.getElementById('abacus-stage'),
            countInp: document.getElementById('inp-count'),
            speedInp: document.getElementById('inp-speed'),
            counterCurrent: document.getElementById('current-index'),
            counterTotal: document.getElementById('total-count'),
            btnStop: document.getElementById('btn-stop'),
            btnHistory: document.getElementById('btn-history'),
            speedModal: document.getElementById('speed-modal')
        };

        function openSpeedModal() {
            const container = document.getElementById('speed-rows');
            container.innerHTML = '';
            
            const keys = ['slowest', 'slow', 'normal', 'fast', 'fastest'];
            keys.forEach(key => {
                const row = document.createElement('div');
                row.className = 'grid grid-cols-3 gap-2 items-center';
                row.innerHTML = `
                    <div class="font-bold text-gray-700 capitalize pl-2">${key}</div>
                    <input type="number" id="spd-disp-${key}" value="${speeds[key].display}" class="w-full p-2 border rounded-lg text-center font-bold text-sm focus:border-indigo-500 outline-none">
                    <input type="number" id="spd-int-${key}" value="${speeds[key].interval}" class="w-full p-2 border rounded-lg text-center font-bold text-sm focus:border-indigo-500 outline-none">
                `;
                container.appendChild(row);
            });

            els.speedModal.classList.remove('hidden');
            setTimeout(() => {
                els.speedModal.classList.remove('opacity-0');
                document.getElementById('speed-modal-content').classList.remove('scale-95');
                document.getElementById('speed-modal-content').classList.add('scale-100');
            }, 10);
        }

        function closeSpeedModal() {
            els.speedModal.classList.add('opacity-0');
            document.getElementById('speed-modal-content').classList.remove('scale-100');
            document.getElementById('speed-modal-content').classList.add('scale-95');
            setTimeout(() => els.speedModal.classList.add('hidden'), 200);
        }

        function saveSpeeds() {
            const keys = ['slowest', 'slow', 'normal', 'fast', 'fastest'];
            keys.forEach(key => {
                const disp = parseInt(document.getElementById(`spd-disp-${key}`).value);
                const int = parseInt(document.getElementById(`spd-int-${key}`).value);
                if (!isNaN(disp) && !isNaN(int)) {
                    speeds[key] = { display: disp, interval: int };
                }
            });
            localStorage.setItem('abacus_teacher_speeds', JSON.stringify(speeds));
            closeSpeedModal();
        }

        function resetSpeeds() {
            if(confirm("Reset all speeds to default settings?")) {
                speeds = JSON.parse(JSON.stringify(defaultSpeeds));
                localStorage.removeItem('abacus_teacher_speeds');
                closeSpeedModal();
            }
        }

        function generateSequence(count, digits) {
            const min = Math.pow(10, digits - 1);
            const max = Math.pow(10, digits) - 1;
            const totalPossible = max - min + 1;
            const result = [];

            if (totalPossible <= 20 || count > totalPossible) {
                let pool = [];
                while (result.length < count) {
                    if (pool.length === 0) {
                        pool = Array.from({length: totalPossible}, (_, i) => i + min);
                        for (let i = pool.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [pool[i], pool[j]] = [pool[j], pool[i]];
                        }
                        if (result.length > 0 && pool[0] === result[result.length - 1]) {
                             if (pool.length > 1) {
                                 const swapIdx = Math.floor(Math.random() * (pool.length - 1)) + 1;
                                 [pool[0], pool[swapIdx]] = [pool[swapIdx], pool[0]];
                             }
                        }
                    }
                    result.push(pool.pop());
                }
            } else {
                const used = new Set();
                while (result.length < count) {
                    let num;
                    let attempts = 0;
                    do {
                        num = Math.floor(Math.random() * (totalPossible)) + min;
                        attempts++;
                    } while (used.has(num) && attempts < 100);
                    used.add(num);
                    result.push(num);
                }
            }
            return result;
        }

        function startSequence() {
            appState.config.total = parseInt(els.countInp.value) || 10;
            appState.config.speedKey = els.speedInp.value;
            const radioDigits = document.querySelector('input[name="digits"]:checked');
            appState.config.digits = radioDigits ? parseInt(radioDigits.value) : 3;

            appState.sequence = generateSequence(appState.config.total, appState.config.digits);
            appState.currentIndex = 0;
            appState.isPlaying = true;
            document.querySelector('header').classList.add('hidden');
            document.querySelector('footer').classList.add('hidden');
            document.getElementById('floating-stop-btn').classList.remove('hidden');

            els.setup.classList.add('hidden');
            els.display.classList.remove('hidden');
            els.btnStop.classList.remove('hidden');
            els.btnHistory.classList.add('hidden'); 
            els.counterTotal.innerText = appState.config.total;
            els.historyList.innerHTML = '';
            
            els.abacusStage.style.opacity = '1';
            els.abacusStage.innerHTML = '<div class="text-5xl md:text-6xl font-extrabold text-indigo-600 animate-pulse">Ready?</div>';

            appState.timer = setTimeout(() => {
                if(appState.isPlaying) runLoop();
            }, 2000);
        }

        async function runLoop() {
            if(!appState.isPlaying) return;

            if(appState.currentIndex >= appState.sequence.length) {
                endSequence();
                return;
            }

            els.counterCurrent.innerText = appState.currentIndex + 1;
            const num = appState.sequence[appState.currentIndex];
            const currentSpeed = speeds[appState.config.speedKey];

            renderAbacus(num);
            els.abacusStage.style.opacity = '1';
            
            await wait(currentSpeed.display);

            if(!appState.isPlaying) return;

            els.abacusStage.style.opacity = '0';
            await wait(currentSpeed.interval);

            if(!appState.isPlaying) return;
            
            addToHistory(appState.currentIndex + 1, num);
            appState.currentIndex++;
            runLoop();
        }

        function wait(ms) {
            return new Promise(resolve => {
                appState.timer = setTimeout(resolve, ms);
            });
        }

        function stopSequence() {
            appState.isPlaying = false;
            clearTimeout(appState.timer);
            endSequence();
        }

        function endSequence() {
            document.querySelector('header').classList.remove('hidden');
            document.querySelector('footer').classList.remove('hidden');
            document.getElementById('floating-stop-btn').classList.add('hidden');
            appState.isPlaying = false;
            els.btnStop.classList.add('hidden');
            els.btnHistory.classList.remove('hidden');
            els.display.classList.add('hidden');
            els.setup.classList.remove('hidden');
            toggleHistory();
            
            els.abacusStage.style.opacity = '1';
            els.abacusStage.innerHTML = '';
        }

        function addToHistory(idx, num) {
            const row = document.createElement('tr');
            row.className = "hover:bg-indigo-50 transition-colors";
            const time = new Date().toLocaleTimeString([], { hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit" });
            row.innerHTML = `
                <td class="py-2 pl-2 border-b border-gray-100 text-gray-400 font-bold">${idx}</td>
                <td class="py-2 border-b border-gray-100 font-bold text-lg text-gray-800">${num}</td>
                <td class="py-2 border-b border-gray-100 text-right text-xs text-gray-400 font-mono">${time}</td>
            `;
            els.historyList.appendChild(row);
        }

        function toggleHistory() {
            const p = els.history;
            if (p.classList.contains('translate-x-full')) {
                p.classList.remove('translate-x-full');
            } else {
                p.classList.add('translate-x-full');
            }
        }

        function downloadHistory() {
            let csv = "Question,Number\n";
            appState.sequence.forEach((n, i) => {
                csv += `${i+1},${n}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'abacus_flash_report.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function fitCardToScreen() {
            const el = document.getElementById('flash-card-container');
            if (!el) return;

            // Reset to measure natural size
            el.style.transform = 'none';

            const cardWidth = el.offsetWidth;
            const cardHeight = el.offsetHeight;

            if (cardWidth === 0 || cardHeight === 0) return;

            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            const scale = Math.min(
                (windowWidth * 0.90) / cardWidth,
                (windowHeight * 0.90) / cardHeight
            );

            el.style.transform = `scale(${scale})`;
        }

        window.addEventListener('resize', fitCardToScreen);

        function renderAbacus(num) {
            const container = els.abacusStage;
            container.innerHTML = '';
            const strNum = num.toString();
            
            for(let i=0; i<strNum.length; i++) {
                const digit = parseInt(strNum[i]);
                const topActive = digit >= 5;
                const remainder = digit % 5;

                const col = document.createElement('div');
                col.className = 'column-container';
                
                const rod = document.createElement('div');
                rod.className = 'abacus-rod';
                col.appendChild(rod);

                const heaven = document.createElement('div');
                heaven.className = 'heaven-deck';
                
                const topBead = document.createElement('div');
                topBead.className = `bead-shape`;
                topBead.style.top = topActive ? 'calc(var(--heaven-h) - var(--bead-h))' : '0px';
                
                heaven.appendChild(topBead);
                col.appendChild(heaven);

                const beam = document.createElement('div');
                beam.className = 'abacus-beam';
                col.appendChild(beam);

                const earth = document.createElement('div');
                earth.className = 'earth-deck';
                
                for(let b=0; b<4; b++) {
                    const bead = document.createElement('div');
                    bead.className = 'bead-shape';
                    if (b < remainder) {
                        bead.style.top = `calc(${b} * var(--bead-h))`;
                    } else {
                        bead.style.top = `calc((${b} * var(--bead-h)) + 45px)`; 
                    }
                    earth.appendChild(bead);
                }
                col.appendChild(earth);
                container.appendChild(col);
            }
            fitCardToScreen();
        }
    </script>
</body>
</html>
