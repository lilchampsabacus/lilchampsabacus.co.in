<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conditional Vertical Addition Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the vertical sum layout and fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }

        /* The math grid layout using CSS Grid */
        .math-grid {
            /* 1. Reduced width to 50% */
            display: grid;
            /* Using a single column */
            grid-template-columns: 1fr; 
            gap: 4px;
            /* Set max-width to 50% of parent container */
            max-width: 50%; 
            width: 100%;
            margin: 0 auto 1.5rem; /* Center the grid horizontally */
        }

        .number-cell {
            font-family: 'Roboto Mono', monospace;
            font-size: 2.5rem; /* Large text for easy reading */
            font-weight: 700;
            text-align: center; 
            padding: 0 5px; 
            color: #1f2937; /* Default dark gray text */
        }

        /* The dividing line for the sum */
        .horizontal-line {
            grid-column: 1 / 2; /* Now spans the single column */
            height: 3px;
            background-color: #333;
            margin: 4px 0;
            border-radius: 9999px;
        }

        #answer-input {
            grid-column: 1 / 2; 
            text-align: center; /* Center the input text */
            border: none;
            border-radius: 0.5rem;
            padding: 8px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            font-size: 2.5rem;
            width: 100%;
            transition: border-color 0.2s;
        }

        /* CSS Animation to highlight the next button */
        .highlight-next {
            animation: pulse-shadow 1.5s infinite;
        }

        @keyframes pulse-shadow {
            0%, 100% {
                box-shadow: 0 0 0 0px rgba(79, 70, 229, 0.7);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(79, 70, 229, 0);
                transform: scale(1.02);
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col font-sans">
    
    <header class="bg-yellow-200 text-black p-4 shadow-lg sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-xl sm:text-2xl font-bold">Li'l Champs Abacus Academy Ambernath East and West</h1>
        </div>
    </header>

    <main class="flex-grow flex items-center justify-center p-4">
        <div id="app-container" class="w-full max-w-xl bg-white p-6 md:p-10 rounded-3xl shadow-2xl border border-gray-100">
            <h1 class="text-3xl font-bold text-center text-indigo-700 mb-2">Addition/Subtraction Practice</h1>
            
            <div class="text-lg font-bold text-blue-700 mb-4 border-b pb-2 text-center">
                Student: <span id="student-name-display" class="text-blue-900">...</span>
            </div>
            
            <p class="text-sm text-center text-gray-500 mb-6">Numbers are restricted to +/- 11, 22, 33, ... 99 based on rules.</p>

            <div class="flex justify-center items-center mb-6">
                <div class="text-2xl font-bold text-indigo-700 bg-indigo-100 px-4 py-2 rounded-lg shadow-md">
                    Question <span id="current-question-number">1</span> of <span id="total-questions">20</span>
                </div>
                </div>

            <div id="question-area" class="flex flex-col items-center justify-center p-8 bg-indigo-50 rounded-2xl mb-6 shadow-inner">
                </div>

            <div id="feedback-area" class="h-10 text-center font-semibold text-lg mb-6">
                </div>

            <div id="control-buttons" class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="submit-button" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition duration-200 shadow-lg" onclick="checkAnswer()">
                    Check Answer
                </button>
                <button id="next-button" class="flex-1 bg-gray-300 text-gray-600 font-bold py-3 px-6 rounded-xl transition duration-200 cursor-not-allowed" disabled onclick="nextQuestion()">
                    Next Sum &rarr;
                </button>
            </div>
            
            <section id="report-area" class="hidden flex justify-center mt-8">
                <div class="max-w-fit w-full bg-green-50 border-4 border-green-300 p-6 rounded-xl shadow-2xl">

                    <h3 class="text-3xl font-extrabold text-green-700 mb-1 border-b-2 pb-1" id="report-title">Conditional Vertical Addition Quiz Report</h3>

                    <p class="text-sm font-semibold text-gray-600 mb-3 border-b pb-1">
                        Date & Time: <span id="report-datetime" class="font-medium text-gray-800"></span>
                    </p>
                    <p class="text-base mb-4">User Name: <span id="report-student-name" class="font-bold text-blue-800"></span></p>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-3 rounded-lg shadow-md border-l-4 border-green-500">
                            <p class="text-xs text-gray-500">No. of Correct Sums</p>
                            <p class="text-xl font-bold text-green-600" id="report-correct">0</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg shadow-md border-l-4 border-purple-500">
                            <p class="text-xs text-gray-500">No. of Sums Attempted</p>
                            <p class="text-xl font-bold text-purple-900" id="report-attempted">0</p>
                        </div>
                    </div>

                    <p class="mt-8 text-center text-sm font-bold text-gray-700 p-3 bg-red-100 border border-red-300 rounded-lg shadow-md">
                        üì∏ Take screenshot of this report and send to your Abacus teacher.
                    </p>
                    
                    <button class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300" onclick="location.reload()">
                        Practice again
                    </button>
                    <button class="mt-2 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300" onclick="window.location.href = 'plus_minus.html'">
                        Back to Plus minus
                    </button>
                </div>
            </section>
        </div>
    </main>

    <div class="max-w-7xl mx-auto w-full p-4 sm:p-6 text-center">
        <a href="plus_minus.html" class="text-blue-600 hover:text-blue-800 font-semibold underline transition duration-150">
            &larr; Back to Plus Minus
        </a>
        
    <footer class="bg-yellow-200 text-black p-3 mt-8 shadow-inner">
        <div class="max-w-7xl mx-auto text-center">
            <p class="text-sm">For any queries call 9730482620</p>
        </div>
    </footer>

    <script>
        // --- Configuration and Data ---
        const TOTAL_QUESTIONS = 20;
        const POSITIVE_NUMBERS = [11, 22, 33, 44, 55, 66, 77, 88, 99];
        const NEGATIVE_NUMBERS = [-11, -22, -33, -44, -55, -66, -77, -88, -99];
        const N2_RESTRICTED_NEGATIVE = [-11, -22, -33, -44];
        
        const quizData = [];
        let currentQuestionIndex = 0;
        let correctAnswersCount = 0;

        // --- DOM Elements ---
        const questionArea = document.getElementById('question-area');
        const submitButton = document.getElementById('submit-button');
        const nextButton = document.getElementById('next-button');
        const feedbackArea = document.getElementById('feedback-area');
        const currentQNumSpan = document.getElementById('current-question-number');
        const studentNameDisplay = document.getElementById('student-name-display');
        const controlButtons = document.getElementById('control-buttons');
        const reportArea = document.getElementById('report-area');


        // --- Utility Functions ---
        
        /**
         * Extracts a formatted name (First Name Last Name) from a student identifier 
         * which is expected to be an email-like string (e.g., "first.last@domain.com").
         */
        function formatStudentName(identifier) {
            if (!identifier || typeof identifier !== 'string') {
                return 'Student';
            }
            
            const namePart = identifier.split('@')[0];
            const parts = namePart.split('.');
            
            let formattedName = parts.map(part => {
                if (part.length > 0) {
                    return part.charAt(0).toUpperCase() + part.slice(1).toLowerCase();
                }
                return '';
            }).filter(p => p.length > 0)
              .join(' ');
              
            return formattedName || identifier; 
        }

        /**
         * Helper function to get a random element from an array.
         */
        function getRandomElement(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        /**
         * Generates a single question based on the user-defined constraints.
         */
        function generateQuestion() {
            // 1. First Number (N1): Always positive (11, 22, ..., 99)
            const N1 = getRandomElement(POSITIVE_NUMBERS);

            // 2. Second Number (N2) logic
            let N2;
            if (N1 > 55) {
                // If N1 > 55, N2 should be in [-11, -22, -33, -44] OR full positive set
                const restrictedSet = N2_RESTRICTED_NEGATIVE.concat(POSITIVE_NUMBERS);
                N2 = getRandomElement(restrictedSet);
            } else { 
                // If N1 <= 55, N2 should be in [+11 to +99] (Full positive set)
                N2 = getRandomElement(POSITIVE_NUMBERS);
            }

            // 3. Third Number (N3) logic
            const Sum12 = N1 + N2;
            let N3;

            if (Sum12 > 100) {
                // If Sum12 > 100, N3 should be between -11 to -99 (Full negative set)
                N3 = getRandomElement(NEGATIVE_NUMBERS);
            } else { 
                // If Sum12 <= 100, N3 should be between +11 to +99 (Full positive set)
                N3 = getRandomElement(POSITIVE_NUMBERS);
            }

            const numbers = [N1, N2, N3];
            
            // Calculation is correct using Array.reduce for robustness
            const correctAnswer = numbers.reduce((sum, n) => sum + n, 0);

            return {
                numbers: numbers,
                correctAnswer: correctAnswer,
                userAnswer: null,
                isCorrect: null
            };
        }

        /**
         * Helper to format a single number row for display, handling the sign.
         */
        function formatNumberRow(number, isFirst = false) {
            
            if (isFirst) {
                // First number (N1) is always positive, and we don't display a leading sign.
                return `<div class="number-cell">${Math.abs(number)}</div>`;
            }

            // For N2 and N3: 
            let displayString;
            if (number < 0) {
                // Prepend the minus sign to the number string
                displayString = `-${Math.abs(number)}`;
            } else {
                // If positive, just show the magnitude (no explicit plus sign)
                displayString = `${number}`;
            }

            return `
                <div class="number-cell">${displayString}</div>
            `;
        }
        
        // --- Core Quiz Logic ---

        /**
         * Initializes the quiz by generating all 20 questions and checking login.
         */
        function initQuiz() {
            const studentIdentifier = sessionStorage.getItem('studentIdentifier');
            if (!studentIdentifier) {
                alert("Login Required. You will be redirected to the main menu.");
                window.location.href = 'index.html'; 
                return;
            }

            studentNameDisplay.textContent = formatStudentName(studentIdentifier);

            try {
                for (let i = 0; i < TOTAL_QUESTIONS; i++) {
                    quizData.push(generateQuestion());
                }
                renderQuestion();
            } catch (e) {
                console.error("Error during quiz initialization:", e);
                feedbackArea.textContent = "Error loading quiz data. Check console for details.";
            }
        }

        /**
         * Renders the current question to the UI, and updates the question number.
         */
        function renderQuestion() {
            if (currentQuestionIndex >= TOTAL_QUESTIONS) {
                showCompletionReport();
                return;
            }

            const currentQ = quizData[currentQuestionIndex];
            
            questionArea.innerHTML = '';
            feedbackArea.textContent = '';
            
            // FIX: Update Question Number Display Here
            currentQNumSpan.textContent = currentQuestionIndex + 1;

            const grid = document.createElement('div');
            grid.className = 'math-grid';

            // All rows now use the single column
            grid.innerHTML += formatNumberRow(currentQ.numbers[0], true); 
            grid.innerHTML += formatNumberRow(currentQ.numbers[1]);
            grid.innerHTML += formatNumberRow(currentQ.numbers[2]);
            
            grid.innerHTML += `<div class="horizontal-line"></div>`;

            // Input now uses the single column
            const inputHtml = `
                <input type="number" id="answer-input" placeholder="Answer" class="answer-input">
            `;
            grid.innerHTML += inputHtml;
            
            questionArea.appendChild(grid);
            
            // Reset control states
            submitButton.disabled = false;
            submitButton.classList.replace('bg-gray-400', 'bg-indigo-600');
            nextButton.disabled = true;
            nextButton.classList.remove('highlight-next', 'bg-indigo-600', 'text-white');
            nextButton.classList.add('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');

            // Add event listener for 'Enter' key press on the newly created input
            const answerInput = document.getElementById('answer-input');
            answerInput.addEventListener('keyup', (event) => {
                if(event.key === 'Enter') checkAnswer();
            });

            answerInput.focus();
        }

        /**
         * Checks the user's answer against the correct answer.
         */
        function checkAnswer() {
            const inputElement = document.getElementById('answer-input');
            const userAnswer = parseInt(inputElement.value, 10);
            const currentQ = quizData[currentQuestionIndex];

            if (isNaN(userAnswer) || inputElement.value.trim() === '') {
                feedbackArea.className = 'h-10 text-center font-semibold text-lg mb-6 text-yellow-600';
                feedbackArea.textContent = "Please enter a valid number first.";
                return;
            }

            // Only update correct count if the question hasn't been checked yet (i.e., submit is enabled)
            if (!submitButton.disabled) {
                currentQ.userAnswer = userAnswer;
                const isCorrect = (userAnswer === currentQ.correctAnswer);
                currentQ.isCorrect = isCorrect;
                
                if (isCorrect) {
                    correctAnswersCount++;
                    feedbackArea.className = 'h-10 text-center font-semibold text-lg mb-6 text-green-700';
                    feedbackArea.textContent = "‚úÖ Correct! Well done.";
                    inputElement.classList.remove('border-4', 'border-red-500');
                } else {
                    feedbackArea.className = 'h-10 text-center font-semibold text-lg mb-6 text-red-700';
                    feedbackArea.innerHTML = `‚ùå Incorrect. The correct answer is: <span class="text-blue-600">${currentQ.correctAnswer}</span>`;
                    inputElement.classList.add('border-4', 'border-red-500');
                }
                
                submitButton.disabled = true;
                submitButton.classList.replace('bg-indigo-600', 'bg-gray-400');
                
                nextButton.disabled = false;
                nextButton.classList.remove('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');
                nextButton.classList.add('bg-indigo-600', 'text-white', 'highlight-next');
            }
        }

        /**
         * Moves to the next question or finishes the quiz.
         */
        function nextQuestion() {
            nextButton.classList.remove('highlight-next');
            
            currentQuestionIndex++;
            
            if (currentQuestionIndex < TOTAL_QUESTIONS) {
                renderQuestion();
            } else {
                showCompletionReport();
            }
        }
        
        /**
         * Displays the final score report (similar to 2D20R).
         */
        function showCompletionReport() {
            // Hide quiz elements
            questionArea.classList.add('hidden');
            controlButtons.classList.add('hidden');
            feedbackArea.classList.add('hidden');
            document.querySelector('.flex.justify-center.items-center.mb-6').classList.add('hidden'); // Hide Q status
            
            // Show report area
            reportArea.classList.remove('hidden');
            reportArea.classList.add('flex');
            
            // Update report stats
            const attemptedCount = TOTAL_QUESTIONS; 
            const correctCount = correctAnswersCount;

            const now = new Date();
            const date = ('0' + now.getDate()).slice(-2);
            const month = ('0' + (now.getMonth() + 1)).slice(-2);
            const year = String(now.getFullYear()).slice(-2);
            const hours = ('0' + now.getHours()).slice(-2);
            const mins = ('0' + now.getMinutes()).slice(-2);            
            const formattedDateTime = `${date}/${month}/${year} at ${hours}:${mins}`;
            
            const studentIdentifier = sessionStorage.getItem('studentIdentifier'); 
            
            document.getElementById('report-datetime').textContent = formattedDateTime;
            document.getElementById('report-student-name').textContent = formatStudentName(studentIdentifier);
            document.getElementById('report-attempted').textContent = attemptedCount; 
            document.getElementById('report-correct').textContent = correctCount; 
            
            document.getElementById('report-title').textContent = "2nd level Addition/Subtraction Report";
        }

        // Initialize the quiz when the page loads
        document.addEventListener('DOMContentLoaded', initQuiz);
    </script>
</body>
</html>
